
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Agentic Context Engineering — Self-Improving Language Model Agents">
      
      
      
        <link rel="canonical" href="https://kayba-ai.github.io/agentic-context-engine/latest/ACE_DESIGN/">
      
      
      
      
        
      
      
      <link rel="icon" href="../assets/Kayba_logo_rounded.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
<title>ACE Documentation</title>

    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ace-architecture-design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ACE Documentation" class="md-header__button md-logo" aria-label="ACE Documentation" data-md-component="logo">
      
  <img src="../assets/Kayba_logo_rounded.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ACE Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ACE Architecture Design
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/kayba-ai/agentic-context-engine" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    kayba-ai/agentic-context-engine
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../getting-started/installation/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../concepts/overview/" class="md-tabs__link">
          
  
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../guides/full-pipeline/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../pipeline/" class="md-tabs__link">
          
  
  
  Pipeline Engine

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../integrations/" class="md-tabs__link">
          
  
  
  Integrations

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../api/" class="md-tabs__link">
        
  
  
    
  
  API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ACE Documentation" class="md-nav__button md-logo" aria-label="ACE Documentation" data-md-component="logo">
      
  <img src="../assets/Kayba_logo_rounded.png" alt="logo">

    </a>
    ACE Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kayba-ai/agentic-context-engine" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    kayba-ai/agentic-context-engine
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How ACE Works
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/skillbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    The Skillbook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/roles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Three Roles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/insight-levels/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Insight Levels
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/updates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Update Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/full-pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Full Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integration Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Prompt Engineering
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/async-learning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Async Learning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Pipeline Engine
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pipeline Engine
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/core-concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Execution Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/branching/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Branching & Parallelism
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/error-handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Error Handling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/custom-steps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building Custom Steps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Integrations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Integrations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrations/litellm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LiteLLM
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrations/langchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LangChain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrations/browser-use/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Browser-Use
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrations/claude-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Claude Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../integrations/opik/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Opik Observability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementation-status" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Status
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        Goals
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#naming-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Naming Changes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Types
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sample-unchanged" class="md-nav__link">
    <span class="md-ellipsis">
      
        Sample (unchanged)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acesample-protocol-for-step-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACESample — protocol for step access
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skillbookview-read-only-projection" class="md-nav__link">
    <span class="md-ellipsis">
      
        SkillbookView — read-only projection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acestepcontext" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACEStepContext
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protocols
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llmclientlike" class="md-nav__link">
    <span class="md-ellipsis">
      
        LLMClientLike
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-protocols-not-abc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why protocols, not ABC
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#class-hierarchy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Class Hierarchy
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acerunner-shared-base" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACERunner — shared base
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ACERunner — shared base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      
        Responsibilities
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generic-run-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generic run loop
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#traceanalyser" class="md-nav__link">
    <span class="md-ellipsis">
      
        TraceAnalyser
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TraceAnalyser">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-to-use" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to use
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context-building" class="md-nav__link">
    <span class="md-ellipsis">
      
        Context building
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interface" class="md-nav__link">
    <span class="md-ellipsis">
      
        Interface
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-epoch-semantics" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi-epoch semantics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-delegates-to-_run" class="md-nav__link">
    <span class="md-ellipsis">
      
        run() — delegates to _run()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ace" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACE
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ACE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#when-to-use_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to use
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipeline
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#context-building_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Context building
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interface_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Interface
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#single-pass-vs-multi-epoch" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single-pass vs multi-epoch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-delegates-to-_run_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        run() — delegates to _run()
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#factory-methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        Factory Methods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Factory Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from_roles-explicit-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_roles — explicit construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-parameters-on-from_roles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common parameters on from_roles
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Steps
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step Summary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentstep" class="md-nav__link">
    <span class="md-ellipsis">
      
        AgentStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluatestep" class="md-nav__link">
    <span class="md-ellipsis">
      
        EvaluateStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reflectstep" class="md-nav__link">
    <span class="md-ellipsis">
      
        ReflectStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tagstep" class="md-nav__link">
    <span class="md-ellipsis">
      
        TagStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updatestep" class="md-nav__link">
    <span class="md-ellipsis">
      
        UpdateStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applystep" class="md-nav__link">
    <span class="md-ellipsis">
      
        ApplyStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deduplicatestep" class="md-nav__link">
    <span class="md-ellipsis">
      
        DeduplicateStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#checkpointstep" class="md-nav__link">
    <span class="md-ellipsis">
      
        CheckpointStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opikstep" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpikStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loadtracesstep" class="md-nav__link">
    <span class="md-ellipsis">
      
        LoadTracesStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openclawtotracestep" class="md-nav__link">
    <span class="md-ellipsis">
      
        OpenClawToTraceStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persiststep" class="md-nav__link">
    <span class="md-ellipsis">
      
        PersistStep
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exportskillbookmarkdownstep" class="md-nav__link">
    <span class="md-ellipsis">
      
        ExportSkillbookMarkdownStep
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reflector" class="md-nav__link">
    <span class="md-ellipsis">
      
        Reflector
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#skillmanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        SkillManager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#shared-helpers-implementationshelperspy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shared Helpers (implementations/helpers.py)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prompt-templates-implementationspromptspy" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prompt Templates (implementations/prompts.py)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deduplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deduplication
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deduplication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#similaritydetector" class="md-nav__link">
    <span class="md-ellipsis">
      
        SimilarityDetector
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deduplicationmanager" class="md-nav__link">
    <span class="md-ellipsis">
      
        DeduplicationManager
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consolidation-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Consolidation Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipeline-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Pipeline Integration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integration-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integration Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#core-idea-execute-convert-learn" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core idea: execute → convert → learn
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#two-step-contract" class="md-nav__link">
    <span class="md-ellipsis">
      
        Two-step contract
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-two-steps-instead-of-one" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why two steps instead of one
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#result-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        Result types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-browser-use-execute-step" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example — browser-use execute step
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#composing-into-a-runner" class="md-nav__link">
    <span class="md-ellipsis">
      
        Composing into a runner
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#learning_tail-reusable-learning-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        learning_tail() — reusable learning steps
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#traceanalyser-batch-learning-from-recorded-executions" class="md-nav__link">
    <span class="md-ellipsis">
      
        TraceAnalyser — batch learning from recorded executions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#live-vs-offline" class="md-nav__link">
    <span class="md-ellipsis">
      
        Live vs offline
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-convenience-api" class="md-nav__link">
    <span class="md-ellipsis">
      
        High-Level Convenience API
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="High-Level Convenience API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from_model-on-integration-runners" class="md-nav__link">
    <span class="md-ellipsis">
      
        from_model() on integration runners
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-convenience-on-from_roles" class="md-nav__link">
    <span class="md-ellipsis">
      
        Additional convenience on from_roles()
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convenience-lifecycle-methods-on-runners" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convenience lifecycle methods on runners
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acelitellm-standalone-convenience-wrapper" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACELiteLLM — standalone convenience wrapper
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-not-separate-wrapper-classes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why not separate wrapper classes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#directory-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Directory Structure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Directory Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-moves-where" class="md-nav__link">
    <span class="md-ellipsis">
      
        What moves where
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#async-behaviour" class="md-nav__link">
    <span class="md-ellipsis">
      
        Async Behaviour
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Async Behaviour">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reflectstep-as-async-boundary" class="md-nav__link">
    <span class="md-ellipsis">
      
        ReflectStep as async boundary
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controlling-concurrency" class="md-nav__link">
    <span class="md-ellipsis">
      
        Controlling concurrency
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#traceanalyser-learn-from-browser-use-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        TraceAnalyser — learn from browser-use history
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ace-live-qa-training" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACE — live Q&amp;A training
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ace-without-environment" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACE — without environment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ace-single-pass-with-iterable" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACE — single-pass with iterable
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ace-with-checkpoints-and-deduplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACE — with checkpoints and deduplication
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-browser-use-runner" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration — browser-use runner
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-langchain-runner-from_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration — LangChain runner (from_model)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-claude-code-runner-from_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integration — Claude Code runner (from_model)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acelitellm-conversational-agent-with-learning" class="md-nav__link">
    <span class="md-ellipsis">
      
        ACELiteLLM — conversational agent with learning
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fire-and-forget-get-results-while-learning-continues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fire-and-forget — get results while learning continues
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mixed-workflow-batch-then-live" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mixed workflow — batch then live
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#potential-improvements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Potential Improvements
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-was-rejected-and-why" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Was Rejected and Why
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="ace-architecture-design">ACE Architecture Design<a class="headerlink" href="#ace-architecture-design" title="Permanent link">&para;</a></h1>
<p>Specification for rewriting the legacy <code>ace/</code> module to use the pipeline engine.</p>
<hr />
<h2 id="implementation-status">Implementation Status<a class="headerlink" href="#implementation-status" title="Permanent link">&para;</a></h2>
<p>Implemented in <code>ace_next/</code> (parallel to <code>ace/</code> for easy rollback). The package is fully self-contained — all types are copied locally, zero imports from <code>ace/</code>.</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Status</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td>Core types (<code>ACEStepContext</code>, <code>SkillbookView</code>, <code>ACESample</code>)</td>
<td>Done</td>
<td><code>ace_next/context.py</code></td>
</tr>
<tr>
<td>Data types (<code>Skill</code>, <code>Skillbook</code>, <code>UpdateBatch</code>, outputs)</td>
<td>Done</td>
<td><code>ace_next/skill.py</code>, <code>skillbook.py</code>, <code>updates.py</code>, <code>outputs.py</code></td>
</tr>
<tr>
<td>Environments (<code>Sample</code>, <code>TaskEnvironment</code>, etc.)</td>
<td>Done</td>
<td><code>ace_next/environments.py</code></td>
</tr>
<tr>
<td>Protocols (<code>AgentLike</code>, <code>ReflectorLike</code>, etc.)</td>
<td>Done</td>
<td><code>ace_next/protocols/</code></td>
</tr>
<tr>
<td>Steps (all 10)</td>
<td>Done</td>
<td><code>ace_next/steps/</code></td>
</tr>
<tr>
<td><code>learning_tail()</code> helper</td>
<td>Done</td>
<td><code>ace_next/steps/__init__.py</code></td>
</tr>
<tr>
<td><code>ACERunner</code> base class</td>
<td>Done</td>
<td><code>ace_next/runners/base.py</code></td>
</tr>
<tr>
<td><code>TraceAnalyser</code></td>
<td>Done</td>
<td><code>ace_next/runners/trace_analyser.py</code></td>
</tr>
<tr>
<td><code>ACE</code> runner</td>
<td>Done</td>
<td><code>ace_next/runners/ace.py</code></td>
</tr>
<tr>
<td>Implementations (<code>Agent</code>, <code>Reflector</code>, <code>SkillManager</code>)</td>
<td>Done</td>
<td><code>ace_next/implementations/</code></td>
</tr>
<tr>
<td>Deduplication (<code>DeduplicationManager</code>, <code>SimilarityDetector</code>)</td>
<td>Done</td>
<td><code>ace_next/deduplication/</code></td>
</tr>
<tr>
<td>Integration steps (<code>BrowserExecuteStep</code>, <code>LangChainExecuteStep</code>, <code>ClaudeCodeExecuteStep</code>)</td>
<td>Done</td>
<td><code>ace_next/integrations/</code></td>
</tr>
<tr>
<td>Integration runners (<code>BrowserUse</code>, <code>LangChain</code>, <code>ClaudeCode</code>)</td>
<td>Done</td>
<td><code>ace_next/runners/</code></td>
</tr>
<tr>
<td>Convenience <code>from_model()</code> on integration runners</td>
<td>Done</td>
<td><code>ace_next/runners/browser_use.py</code>, <code>langchain.py</code>, <code>claude_code.py</code></td>
</tr>
<tr>
<td><code>ACELiteLLM</code> convenience wrapper</td>
<td>Done</td>
<td><code>ace_next/runners/litellm.py</code></td>
</tr>
<tr>
<td>LLM providers (<code>LiteLLMClient</code>, <code>InstructorClient</code>, <code>LangChainLiteLLMClient</code>, <code>ClaudeCodeLLMClient</code>)</td>
<td>Done</td>
<td><code>ace_next/providers/</code></td>
</tr>
<tr>
<td>Recursive Reflector</td>
<td>Done</td>
<td><code>ace_next/rr/</code> (SubRunner base in <code>ace_next/core/</code>)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="goals">Goals<a class="headerlink" href="#goals" title="Permanent link">&para;</a></h2>
<ol>
<li>Replace the monolithic <code>ACEBase</code> / <code>OfflineACE</code> / <code>OnlineACE</code> in <code>adaptation.py</code> with pipeline-based classes.</li>
<li>Rename to match what each class actually does:</li>
<li><strong>TraceAnalyser</strong>: takes pre-recorded traces, outputs a skillbook. Replaces the concept of "offline" learning.</li>
<li><strong>ACE</strong>: the live adaptive pipeline. Replaces the concept of "online" learning. Also supports multi-epoch batch runs.</li>
<li>Clean OOP: shared base class, composition over inheritance, pluggable steps.</li>
<li>Unify the integration pattern — external frameworks produce raw trace objects (any type), TraceAnalyser passes them to the Reflector as-is.</li>
<li>Maximise step granularity — each step does one thing so concerns are separated and each step is independently testable.</li>
</ol>
<hr />
<h2 id="naming-changes">Naming Changes<a class="headerlink" href="#naming-changes" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>Legacy</th>
<th>New</th>
<th>What it does</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OfflineACE</code></td>
<td><code>TraceAnalyser</code></td>
<td>Analyse pre-recorded traces → evolve a skillbook</td>
</tr>
<tr>
<td><code>OnlineACE</code></td>
<td><code>ACE</code></td>
<td>Live execution → feedback → learning loop</td>
</tr>
<tr>
<td><code>ACEBase</code></td>
<td><code>ACERunner</code></td>
<td>Shared runner infrastructure (composition, not inheritance from Pipeline)</td>
</tr>
<tr>
<td><code>ACEStepResult</code></td>
<td>Removed — use <code>SampleResult</code> from the pipeline engine</td>
<td>Unified result type</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="core-types">Core Types<a class="headerlink" href="#core-types" title="Permanent link">&para;</a></h2>
<h3 id="sample-unchanged">Sample (unchanged)<a class="headerlink" href="#sample-unchanged" title="Permanent link">&para;</a></h3>
<p>The existing <code>Sample</code> dataclass stays as-is. ACE uses it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Sample</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">ground_truth</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<h3 id="acesample-protocol-for-step-access">ACESample — protocol for step access<a class="headerlink" href="#acesample-protocol-for-step-access" title="Permanent link">&para;</a></h3>
<p>Steps access <code>ctx.sample.question</code> uniformly. A <code>Protocol</code> makes this duck typing explicit and type-safe:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ACESample</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimal interface that Sample satisfies.&quot;&quot;&quot;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="nd">@property</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">question</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="nd">@property</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="nd">@property</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ground_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="nd">@property</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<p><code>ACEStepContext.sample</code> is typed as <code>ACESample</code>. <code>Sample</code> satisfies it structurally. Mypy validates both sides: producers must provide the attributes, consumers can rely on them.</p>
<h3 id="skillbookview-read-only-projection">SkillbookView — read-only projection<a class="headerlink" href="#skillbookview-read-only-projection" title="Permanent link">&para;</a></h3>
<p>The <code>Skillbook</code> is mutable — steps add, tag, and remove skills. Putting it directly on a <code>frozen=True</code> context would allow mutation through the reference (<code>ctx.skillbook.tag_skill(...)</code> succeeds even though <code>ctx.skillbook = other</code> fails). That breaks the immutability guarantee.</p>
<p><code>SkillbookView</code> solves this. It wraps a <code>Skillbook</code> and exposes only read methods. Write methods don't exist on the class — calling them raises <code>AttributeError</code> at runtime and a type error at check time.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SkillbookView</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Read-only projection of a Skillbook. Safe on a frozen context.&quot;&quot;&quot;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_sb&quot;</span><span class="p">,)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">as_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span><span class="o">.</span><span class="n">as_prompt</span><span class="p">()</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_skill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skill_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Skill</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span><span class="o">.</span><span class="n">get_skill</span><span class="p">(</span><span class="n">skill_id</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">skills</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_invalid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Skill</span><span class="p">]:</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span><span class="o">.</span><span class="n">skills</span><span class="p">(</span><span class="n">include_invalid</span><span class="o">=</span><span class="n">include_invalid</span><span class="p">)</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sb</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sb</span><span class="o">.</span><span class="n">skills</span><span class="p">())</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sb</span><span class="o">.</span><span class="n">skills</span><span class="p">())</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;SkillbookView(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2"> skills)&quot;</span>
</code></pre></div>
<p><strong>Enforcement:</strong>
- <strong>Type checker</strong> — mypy/pyright flags <code>ctx.skillbook.add_skill(...)</code> because <code>SkillbookView</code> has no such method.
- <strong>Runtime</strong> — <code>AttributeError</code> if someone calls a write method anyway.
- <strong>Convention</strong> — the underlying <code>_sb</code> is underscore-prefixed. Accessing it is a deliberate violation, not an accident.</p>
<p>Steps that only <strong>read</strong> the skillbook (AgentStep, ReflectStep, UpdateStep, OpikStep) access <code>ctx.skillbook</code> — the view. Steps that <strong>write</strong> the skillbook (TagStep, ApplyStep, DeduplicateStep, CheckpointStep) receive the real <code>Skillbook</code> via constructor injection and use <code>self.skillbook</code>.</p>
<h3 id="acestepcontext">ACEStepContext<a class="headerlink" href="#acestepcontext" title="Permanent link">&para;</a></h3>
<p>Subclass of the pipeline engine's <code>StepContext</code>. Carries all step-to-step data for the ACE pipeline. The pipeline engine only knows about <code>sample</code> and <code>metadata</code>; all ACE-specific fields live here.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ACEStepContext</span><span class="p">(</span><span class="n">StepContext</span><span class="p">):</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Immutable context for the ACE pipeline.</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="sd">    The skillbook field is a SkillbookView (read-only). Steps that need to</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="sd">    write to the skillbook receive the real Skillbook via constructor injection.</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">sample</span><span class="p">:</span> <span class="n">ACESample</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="n">skillbook</span><span class="p">:</span> <span class="n">SkillbookView</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="n">trace</span><span class="p">:</span> <span class="nb">object</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">agent_output</span><span class="p">:</span> <span class="n">AgentOutput</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="n">reflection</span><span class="p">:</span> <span class="n">ReflectorOutput</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="n">skill_manager_output</span><span class="p">:</span> <span class="n">UpdateBatch</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="n">total_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>    <span class="n">step_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="n">total_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="n">global_sample_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
<p>The <code>trace</code> field holds the raw execution record from any external system — a browser-use <code>AgentHistoryList</code>, a LangChain result dict, a Claude Code transcript, or any arbitrary Python object. It has no enforced schema. The Reflector receives the raw trace and is responsible for making sense of it — this gives maximum flexibility for analysis without constraining trace format. Extraction helpers can be added later as an optional layer if needed.</p>
<p><strong>What goes on the context vs what gets injected:</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>On the context</th>
<th>Injected via constructor</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Nature</strong></td>
<td>Step-to-step data + read-only dependencies</td>
<td>Mutable shared state</td>
</tr>
<tr>
<td><strong>Lifetime</strong></td>
<td>Per-sample (born in <code>_build_context</code>, dies after pipeline)</td>
<td>Per-runner (created once, shared across samples)</td>
</tr>
<tr>
<td><strong>Immutable?</strong></td>
<td>Yes — frozen fields, read-only views</td>
<td>No — mutable by design</td>
</tr>
<tr>
<td><strong>Examples</strong></td>
<td><code>agent_output</code>, <code>reflection</code>, <code>skillbook</code> (view)</td>
<td><code>skillbook</code> (real), <code>environment</code>, <code>dedup_manager</code></td>
</tr>
<tr>
<td><strong>Validated by engine?</strong></td>
<td>Yes — <code>requires</code>/<code>provides</code></td>
<td>No — runtime error if missing</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="protocols">Protocols<a class="headerlink" href="#protocols" title="Permanent link">&para;</a></h2>
<p>Steps depend on protocols, not concrete classes. Each protocol defines the minimal interface a step needs. Concrete implementations satisfy them structurally — no inheritance required.</p>
<p>All protocols live in <code>ace_next/protocols/</code> (one file per protocol, re-exported from <code>__init__.py</code>).</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Method</th>
<th>Used by</th>
<th>Satisfied by</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AgentLike</code></td>
<td><code>generate(question, context, skillbook, reflection, **kwargs) → AgentOutput</code></td>
<td><code>AgentStep</code></td>
<td><code>Agent</code></td>
</tr>
<tr>
<td><code>ReflectorLike</code></td>
<td><code>reflect(question, agent_output, skillbook, ground_truth, feedback, **kwargs) → ReflectorOutput</code></td>
<td><code>ReflectStep</code></td>
<td><code>Reflector</code></td>
</tr>
<tr>
<td><code>SkillManagerLike</code></td>
<td><code>update_skills(reflection, skillbook, question_context, progress, **kwargs) → SkillManagerOutput</code></td>
<td><code>UpdateStep</code></td>
<td><code>SkillManager</code></td>
</tr>
<tr>
<td><code>DeduplicationManagerLike</code></td>
<td><code>get_similarity_report(skillbook) → str \| None</code></td>
<td><code>DeduplicateStep</code></td>
<td><code>DeduplicationManager</code></td>
</tr>
<tr>
<td><code>LLMClientLike</code></td>
<td><code>complete(prompt, **kwargs) → Any</code> + <code>complete_structured(prompt, response_model, **kwargs) → T</code></td>
<td><code>Agent</code>, <code>Reflector</code>, <code>SkillManager</code></td>
<td>Any LLM client with both methods</td>
</tr>
</tbody>
</table>
<h3 id="llmclientlike">LLMClientLike<a class="headerlink" href="#llmclientlike" title="Permanent link">&para;</a></h3>
<p>The implementations (<code>Agent</code>, <code>Reflector</code>, <code>SkillManager</code>) all depend on <code>LLMClientLike</code> — a protocol requiring two methods:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nd">@runtime_checkable</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">LLMClientLike</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">complete_structured</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response_model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<p><code>complete_structured</code> returns a validated Pydantic model instance. This is the key capability — implementations call <code>llm.complete_structured(prompt, AgentOutput)</code> and get back a typed, validated object. Any LLM client that provides both methods satisfies the protocol: <code>LiteLLMClient</code> wrapped with Instructor, a custom OpenAI wrapper, or a mock for testing.</p>
<p><strong>Design decision:</strong> The old <code>ace/roles.py</code> auto-wrapped LLM clients with Instructor if <code>complete_structured</code> was missing. In <code>ace_next</code>, this auto-wrapping is removed — callers must pass a pre-wrapped client (e.g. <code>wrap_with_instructor(LiteLLMClient(...))</code> from <code>ace_next.providers</code>). This makes the requirement explicit.</p>
<h3 id="why-protocols-not-abc">Why protocols, not ABC<a class="headerlink" href="#why-protocols-not-abc" title="Permanent link">&para;</a></h3>
<p>Protocols use structural typing (duck typing checked by mypy). A class satisfies a protocol if it has the right methods — no <code>class Agent(AgentLike)</code> inheritance needed. This means:
- Users can pass any object with a matching method, not just subclasses.
- Mocks satisfy protocols without ceremony.
- Steps are decoupled from implementations at the type level, not just by convention.</p>
<hr />
<h2 id="class-hierarchy">Class Hierarchy<a class="headerlink" href="#class-hierarchy" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>ACERunner (shared infrastructure: epoch loop, delegates to Pipeline.run())
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>├── TraceAnalyser       — [Reflect → Tag → Update → Apply]; input = any trace object
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>├── ACE                 — [Agent → Evaluate → Reflect → Tag → Update → Apply]; input = Sample + Environment
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>├── BrowserUse          — [BrowserExecute → BrowserToTrace → Reflect → Tag → Update → Apply]; input = task strings
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>├── LangChain           — [LangChainExecute → LangChainToTrace → Reflect → Tag → Update → Apply]; input = chain inputs
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>├── ClaudeCode          — [ClaudeCodeExecute → ClaudeCodeToTrace → Reflect → Tag → Update → Apply]; input = task strings
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>└── OpenClaw (script)   — [LoadTraces → OpenClawToTrace → Reflect → Tag → Update → Apply]; input = JSONL trace files
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>ACELiteLLM (standalone convenience wrapper — not an ACERunner subclass)
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>├── ask()               — direct Agent call, no pipeline
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>├── learn()             — delegates to lazy-init ACE runner
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>├── learn_from_traces() — delegates to lazy-init TraceAnalyser
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>└── learn_from_feedback()— manual single-shot learning from last ask()
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>RRStep (SubRunner — composable iterative step)
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>├── __call__()          — StepProtocol entry; can be placed in any runner&#39;s pipeline
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>├── reflect()           — ReflectorLike entry; standalone use
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>└── run_loop()          — SubRunner loop driver; inner Pipeline([LLMCall, ExtractCode, SandboxExec, CheckResult])
</code></pre></div>
<p>All runners compose a <code>Pipeline</code> rather than extending it. <code>RRStep</code> extends <code>SubRunner</code> (from <code>ace_next/core/sub_runner.py</code>) and can be used as a step in any runner's pipeline — it is a black box that satisfies <code>StepProtocol</code>. The pipeline is an implementation detail, not part of the public interface. Each subclass only overrides <code>run()</code> (public signature) and <code>_build_context()</code> (input mapping).</p>
<p>Integration runners (<code>BrowserUse</code>, <code>LangChain</code>, <code>ClaudeCode</code>) each provide two construction paths: <code>from_roles()</code> for pre-built role instances, and <code>from_model()</code> for auto-building roles from a model string. <code>ACELiteLLM</code> is a standalone class (not an <code>ACERunner</code> subclass) because it wraps two different runners and exposes a different API (<code>ask</code>, <code>learn</code>, <code>learn_from_traces</code>).</p>
<p>Each integration runner uses two steps before the learning tail: (1) an <strong>execute step</strong> that produces an integration-specific result type (e.g. <code>BrowserResult</code>), and (2) a <strong>ToTrace step</strong> that converts that result into the standardised trace dict the learning tail expects. This separation keeps framework-specific logic in the execute step and trace formatting in the converter — each is independently testable.</p>
<hr />
<h2 id="acerunner-shared-base">ACERunner — shared base<a class="headerlink" href="#acerunner-shared-base" title="Permanent link">&para;</a></h2>
<p>Encapsulates everything that TraceAnalyser, ACE, and integration runners have in common. The runner's only job is the epoch loop and Iterable validation. Per-sample iteration, error handling, background execution, and checkpoints are all delegated to <code>Pipeline.run()</code>.</p>
<p>Subclasses only override <code>run()</code> (public signature) and <code>_build_context()</code> (input mapping).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ACERunner</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Shared runner infrastructure for all ACE runners.&quot;&quot;&quot;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>        <span class="n">pipeline</span><span class="p">:</span> <span class="n">Pipeline</span><span class="p">,</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">,</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the current skillbook to disk.&quot;&quot;&quot;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Block until all background learning tasks complete.</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="sd">        Delegates to Pipeline.wait_for_background(). Call this after run(wait=False)</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="sd">        before saving the skillbook or reading final results.</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">wait_for_background</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="nd">@property</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">learning_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return background learning progress.</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="sd">        Useful after run(wait=False) to monitor learning without blocking.</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="sd">        Delegates to Pipeline.background_stats() to avoid reaching into</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="sd">        pipeline internals.</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">background_stats</span><span class="p">()</span>
</code></pre></div>
<h3 id="responsibilities">Responsibilities<a class="headerlink" href="#responsibilities" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Concern</th>
<th>Owner</th>
</tr>
</thead>
<tbody>
<tr>
<td>Epoch loop + Iterable validation</td>
<td><code>ACERunner._run()</code></td>
</tr>
<tr>
<td>Per-sample iteration + error isolation</td>
<td><code>Pipeline.run()</code></td>
</tr>
<tr>
<td>Foreground/background split</td>
<td><code>Pipeline.run()</code> (via <code>async_boundary</code>)</td>
</tr>
<tr>
<td>Concurrent workers</td>
<td><code>Pipeline.run(workers=N)</code></td>
</tr>
<tr>
<td>Checkpoints</td>
<td><code>CheckpointStep</code> (in the pipeline, configured at construction)</td>
</tr>
<tr>
<td>Background drain</td>
<td><code>ACERunner.wait_for_background()</code> → <code>Pipeline.wait_for_background()</code></td>
</tr>
<tr>
<td>Background monitoring</td>
<td><code>ACERunner.learning_stats</code></td>
</tr>
<tr>
<td>Skillbook I/O</td>
<td><code>save(path)</code> on the runner (delegates to <code>skillbook.save_to_file()</code>)</td>
</tr>
</tbody>
</table>
<p>Each sample is independent — no state persists across samples. The skillbook is the only cross-sample coupling: read-only steps see it via <code>ctx.skillbook</code> (a <code>SkillbookView</code>), write steps mutate it via <code>self.skillbook</code> (the real <code>Skillbook</code>, injected at construction).</p>
<p><strong>Eventual consistency:</strong> <code>SkillbookView</code> is a thin delegation wrapper, not a snapshot — it reads from the live <code>Skillbook</code> at call time. When background learning is active (<code>async_boundary</code> on <code>ReflectStep</code>), concurrent samples may observe partially-updated skillbook state. For example, Sample 2's <code>ReflectStep</code> might read the skillbook mid-mutation by Sample 1's <code>ApplyStep</code>. This is by design: steps see a best-effort view of the current skillbook rather than a point-in-time snapshot. The trade-off is acceptable because (1) the Reflector and SkillManager use the skillbook as LLM prompt context, where a few missing or extra skills have negligible impact on output quality, (2) serialising all skillbook reads would eliminate the concurrency benefit of <code>max_workers &gt; 1</code> on <code>ReflectStep</code>, and (3) write steps (<code>TagStep</code>, <code>ApplyStep</code>) already run with <code>max_workers = 1</code>, so writes are serialised — only reads interleave with writes. If stricter isolation is ever needed, <code>SkillbookView</code> can be changed to snapshot on construction (deep copy) without altering step code.</p>
<h3 id="generic-run-loop">Generic run loop<a class="headerlink" href="#generic-run-loop" title="Permanent link">&para;</a></h3>
<p>Every subclass delegates to <code>_run()</code>. The only thing that varies per subclass is (1) the public <code>run()</code> signature and (2) the <code>_build_context()</code> method that maps input items to <code>ACEStepContext</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">items</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">,</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SampleResult</span><span class="p">]:</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="k">if</span> <span class="n">epochs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multi-epoch requires a Sequence, not a consumed Iterable.&quot;</span><span class="p">)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SampleResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_build_context</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">total_epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>                                <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>                                <span class="n">global_sample_index</span><span class="o">=</span><span class="p">(</span><span class="n">epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">idx</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">idx</span><span class="p">,</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>        <span class="p">]</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>        <span class="n">epoch_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">contexts</span><span class="p">)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">epoch_results</span><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>    <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">wait_for_background</span><span class="p">()</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>
<p><strong><code>wait</code> parameter:</strong> When <code>wait=True</code> (default), <code>_run()</code> blocks until all background learning completes before returning — results are fully populated. When <code>wait=False</code>, <code>_run()</code> returns immediately after the foreground steps finish. Background learning continues asynchronously. Use <code>wait_for_background()</code> to drain later, or <code>learning_stats</code> to monitor progress.</p>
<p>The runner builds fully-initialized <code>ACEStepContext</code> objects (epoch counters, pre-filled outputs for traces, etc.) and hands them to <code>Pipeline.run(contexts)</code>. Construction IS initialization — from that point on contexts are frozen and the pipeline processes what it receives without wrapping or guessing. <code>Pipeline.run()</code> handles iteration, error isolation, foreground/background split, and concurrent workers. The runner only owns the epoch loop.</p>
<hr />
<h2 id="traceanalyser">TraceAnalyser<a class="headerlink" href="#traceanalyser" title="Permanent link">&para;</a></h2>
<p>Analyses pre-recorded traces without executing an agent. Runs the learning tail only. Accepts raw trace objects of any type — the raw trace is placed directly on <code>ctx.trace</code> and the Reflector is responsible for making sense of it.</p>
<h3 id="when-to-use">When to use<a class="headerlink" href="#when-to-use" title="Permanent link">&para;</a></h3>
<ul>
<li>You have execution logs from an external system (browser-use, LangChain, custom agent, human sessions).</li>
<li>You want to build or refine a skillbook from historical data.</li>
<li>You want to re-analyse the same data multiple times (multi-epoch) to extract deeper patterns.</li>
</ul>
<h3 id="pipeline">Pipeline<a class="headerlink" href="#pipeline" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>[ReflectStep] → [TagStep] → [UpdateStep] → [ApplyStep]
</code></pre></div>
<p>No AgentStep, no EvaluateStep. The trace already contains the agent's output and the evaluation feedback.</p>
<h3 id="context-building">Context building<a class="headerlink" href="#context-building" title="Permanent link">&para;</a></h3>
<p>TraceAnalyser places the raw trace directly on <code>ctx.trace</code>. No extraction, no conversion — the Reflector receives the trace as-is and has full freedom to analyze it however it sees fit.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_build_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_trace</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">total_epochs</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">global_sample_index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="k">return</span> <span class="n">ACEStepContext</span><span class="p">(</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>        <span class="n">skillbook</span><span class="o">=</span><span class="n">SkillbookView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="p">),</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        <span class="n">trace</span><span class="o">=</span><span class="n">raw_trace</span><span class="p">,</span>                         <span class="c1"># raw object, no enforced schema</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="n">total_epochs</span><span class="o">=</span><span class="n">total_epochs</span><span class="p">,</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="n">step_index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="n">total_steps</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="n">global_sample_index</span><span class="o">=</span><span class="n">global_sample_index</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="p">)</span>
</code></pre></div>
<p>The <code>skillbook</code> field is a <code>SkillbookView</code> — read-only steps access it from the context. Write steps (TagStep, ApplyStep) receive the real <code>Skillbook</code> via constructor injection. Each sample is independent — no state carries over from previous samples.</p>
<h3 id="interface">Interface<a class="headerlink" href="#interface" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TraceAnalyser</span><span class="p">(</span><span class="n">ACERunner</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyse pre-recorded traces to build a skillbook.&quot;&quot;&quot;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_roles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TraceAnalyser&quot;</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="n">traces</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SampleResult</span><span class="p">]:</span> <span class="o">...</span>
</code></pre></div>
<p>Note: no <code>environment</code> parameter, no converter. The raw trace goes straight onto the context. The Reflector is responsible for making sense of it — this gives maximum flexibility for analysis without constraining trace format. Extraction into structured fields can be added later as an optional step if needed. No checkpoint parameters — checkpoints are configured at construction time via the factory methods.</p>
<h3 id="multi-epoch-semantics">Multi-epoch semantics<a class="headerlink" href="#multi-epoch-semantics" title="Permanent link">&para;</a></h3>
<p>Each epoch re-processes all traces with the current (evolving) skillbook. Early epochs extract obvious patterns; later epochs refine and consolidate.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>Epoch 1:  trace₁ → trace₂ → ... → traceₙ   (skillbook grows)
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Epoch 2:  trace₁ → trace₂ → ... → traceₙ   (skillbook refines)
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>Epoch 3:  trace₁ → trace₂ → ... → traceₙ   (diminishing returns)
</code></pre></div>
<p>Each sample is independent. The only thing that evolves across samples (and epochs) is the skillbook itself — visible as a read-only <code>SkillbookView</code> on the context, mutated by write steps via the real <code>Skillbook</code> (constructor-injected).</p>
<h3 id="run-delegates-to-_run">run() — delegates to _run()<a class="headerlink" href="#run-delegates-to-_run" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
</code></pre></div>
<p>No epoch loop, no per-sample iteration — <code>_run()</code> handles all of that.</p>
<hr />
<h2 id="ace">ACE<a class="headerlink" href="#ace" title="Permanent link">&para;</a></h2>
<p>The full live adaptive pipeline. An agent executes, the reflector analyses, the skill manager updates. Optionally evaluates against a <code>TaskEnvironment</code> for feedback-driven learning.</p>
<h3 id="when-to-use_1">When to use<a class="headerlink" href="#when-to-use_1" title="Permanent link">&para;</a></h3>
<ul>
<li>You are building a new agent from scratch.</li>
<li>You want closed-loop learning where the agent improves in real time.</li>
<li>Optionally: you have a <code>TaskEnvironment</code> that can evaluate outputs (provides richer feedback for the Reflector).</li>
</ul>
<h3 id="pipeline_1">Pipeline<a class="headerlink" href="#pipeline_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>[AgentStep] → [EvaluateStep] → [ReflectStep] → [TagStep] → [UpdateStep] → [ApplyStep]
</code></pre></div>
<h3 id="context-building_1">Context building<a class="headerlink" href="#context-building_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_build_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">total_epochs</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">global_sample_index</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="k">return</span> <span class="n">ACEStepContext</span><span class="p">(</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>        <span class="n">sample</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        <span class="n">skillbook</span><span class="o">=</span><span class="n">SkillbookView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="p">),</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>        <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>        <span class="n">total_epochs</span><span class="o">=</span><span class="n">total_epochs</span><span class="p">,</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>        <span class="n">step_index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>        <span class="n">total_steps</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>        <span class="n">global_sample_index</span><span class="o">=</span><span class="n">global_sample_index</span><span class="p">,</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="p">)</span>
</code></pre></div>
<p>Each sample is independent. The <code>skillbook</code> field is a <code>SkillbookView</code> (read-only). Write steps receive the real <code>Skillbook</code> via constructor injection. The environment (if any) is injected into <code>EvaluateStep</code> at construction time — it does not appear on the context.</p>
<h3 id="interface_1">Interface<a class="headerlink" href="#interface_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ACE</span><span class="p">(</span><span class="n">ACERunner</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Live adaptive pipeline: Agent → Evaluate → Reflect → Tag → Update → Apply.&quot;&quot;&quot;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_roles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skillbook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ACE&quot;</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>        <span class="n">samples</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sample</span><span class="p">]</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Sample</span><span class="p">],</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>        <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="n">wait</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">SampleResult</span><span class="p">]:</span> <span class="o">...</span>
</code></pre></div>
<p>The <code>environment</code> is optional and provided at construction time, not at <code>run()</code> time. When provided, <code>EvaluateStep</code> uses it to generate feedback that enriches the trace. When omitted, the trace still contains the agent's output, question, context, and ground truth — the Reflector can learn from ground-truth comparison or from the agent's reasoning alone.</p>
<h3 id="single-pass-vs-multi-epoch">Single-pass vs multi-epoch<a class="headerlink" href="#single-pass-vs-multi-epoch" title="Permanent link">&para;</a></h3>
<p>A single class handles both use cases. <code>epochs=1</code> gives single-pass behaviour. <code>epochs &gt; 1</code> gives multi-epoch batch training.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Single pass (was OnlineACE)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="c1"># Multi-epoch batch (was OfflineACE)</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">training_set</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="c1"># Fire-and-forget — agent results returned fast, learning continues in background</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p>When <code>samples</code> is an <code>Iterable</code> (not <code>Sequence</code>), <code>epochs</code> must be <code>1</code> — you cannot replay a consumed iterable. <code>_run()</code> raises <code>ValueError</code> if <code>epochs &gt; 1</code> and <code>samples</code> is not a <code>Sequence</code>. Note: <code>_run()</code> materializes the full iterable into a list of contexts before passing them to <code>Pipeline.run()</code>. This is a deliberate simplification — see Potential Improvements.</p>
<h3 id="run-delegates-to-_run_1">run() — delegates to _run()<a class="headerlink" href="#run-delegates-to-_run_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
</code></pre></div>
<p>No instance state is modified — the runner stays reentrant.</p>
<hr />
<h2 id="factory-methods">Factory Methods<a class="headerlink" href="#factory-methods" title="Permanent link">&para;</a></h2>
<p>All runners provide a <code>from_roles</code> factory that takes pre-built role instances. Integration runners (<code>BrowserUse</code>, <code>LangChain</code>, <code>ClaudeCode</code>) also provide a <code>from_model()</code> factory that auto-builds roles from a model string (see <a href="#high-level-convenience-api">High-Level Convenience API</a>).</p>
<h3 id="from_roles-explicit-construction"><code>from_roles</code> — explicit construction<a class="headerlink" href="#from_roles-explicit-construction" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># TraceAnalyser: bring your own roles</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="n">analyser</span> <span class="o">=</span> <span class="n">TraceAnalyser</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">prompt_template</span><span class="o">=</span><span class="n">custom_prompt</span><span class="p">),</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="n">skillbook</span><span class="o">=</span><span class="n">existing_skillbook</span><span class="p">,</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="p">)</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1"># ACE: bring your own roles</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="n">skillbook</span><span class="o">=</span><span class="n">existing_skillbook</span><span class="p">,</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>    <span class="n">dedup_manager</span><span class="o">=</span><span class="n">DeduplicationManager</span><span class="p">(</span><span class="n">DeduplicationConfig</span><span class="p">(</span><span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)),</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="p">)</span>
</code></pre></div>
<h3 id="common-parameters-on-from_roles">Common parameters on <code>from_roles</code><a class="headerlink" href="#common-parameters-on-from_roles" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>skillbook</code></td>
<td><code>Skillbook()</code></td>
<td>Starting skillbook (empty if not provided)</td>
</tr>
<tr>
<td><code>dedup_manager</code></td>
<td><code>None</code></td>
<td>Appends a <code>DeduplicateStep</code> to the pipeline</td>
</tr>
<tr>
<td><code>dedup_interval</code></td>
<td><code>10</code></td>
<td>Deduplication frequency (samples between runs)</td>
</tr>
<tr>
<td><code>checkpoint_dir</code></td>
<td><code>None</code></td>
<td>Appends a <code>CheckpointStep</code> to the pipeline</td>
</tr>
<tr>
<td><code>checkpoint_interval</code></td>
<td><code>10</code></td>
<td>Checkpoint frequency (samples between saves)</td>
</tr>
<tr>
<td><code>extra_steps</code></td>
<td><code>None</code></td>
<td>Additional steps appended after the learning tail (e.g. <code>OpikStep</code>)</td>
</tr>
</tbody>
</table>
<p>Checkpoint and deduplication are configured at construction time. The factory conditionally appends the corresponding steps to the pipeline tail. <code>extra_steps</code> are appended last — after dedup and checkpoint. Both classes follow the same pattern — ACE prepends its execute steps:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># TraceAnalyser — learning tail only</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nd">@classmethod</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_roles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>               <span class="n">dedup_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dedup_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>               <span class="n">checkpoint_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>               <span class="n">extra_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span> <span class="ow">or</span> <span class="n">Skillbook</span><span class="p">()</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="n">steps</span> <span class="o">=</span> <span class="n">learning_tail</span><span class="p">(</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>        <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>        <span class="n">dedup_manager</span><span class="o">=</span><span class="n">dedup_manager</span><span class="p">,</span> <span class="n">dedup_interval</span><span class="o">=</span><span class="n">dedup_interval</span><span class="p">,</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>        <span class="n">checkpoint_dir</span><span class="o">=</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="n">checkpoint_interval</span><span class="p">,</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>    <span class="p">)</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>    <span class="k">if</span> <span class="n">extra_steps</span><span class="p">:</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>        <span class="n">steps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_steps</span><span class="p">)</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">)</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="c1"># ACE — execute head + learning tail</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="nd">@classmethod</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="k">def</span><span class="w"> </span><span class="nf">from_roles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>               <span class="n">skillbook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dedup_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dedup_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>               <span class="n">checkpoint_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>               <span class="n">extra_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>    <span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span> <span class="ow">or</span> <span class="n">Skillbook</span><span class="p">()</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>    <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>        <span class="n">AgentStep</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
<a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>        <span class="n">EvaluateStep</span><span class="p">(</span><span class="n">environment</span><span class="p">),</span>
<a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>        <span class="o">*</span><span class="n">learning_tail</span><span class="p">(</span>
<a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>            <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>            <span class="n">dedup_manager</span><span class="o">=</span><span class="n">dedup_manager</span><span class="p">,</span> <span class="n">dedup_interval</span><span class="o">=</span><span class="n">dedup_interval</span><span class="p">,</span>
<a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>            <span class="n">checkpoint_dir</span><span class="o">=</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">checkpoint_interval</span><span class="o">=</span><span class="n">checkpoint_interval</span><span class="p">,</span>
<a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>        <span class="p">),</span>
<a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>    <span class="p">]</span>
<a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>    <span class="k">if</span> <span class="n">extra_steps</span><span class="p">:</span>
<a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>        <span class="n">steps</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_steps</span><span class="p">)</span>
<a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">)</span>
</code></pre></div>
<p>Read-only steps (ReflectStep, UpdateStep) access the skillbook via <code>ctx.skillbook</code> (a <code>SkillbookView</code>). Write steps (TagStep, ApplyStep, DeduplicateStep, CheckpointStep) receive the real <code>Skillbook</code> via constructor.</p>
<hr />
<h2 id="steps">Steps<a class="headerlink" href="#steps" title="Permanent link">&para;</a></h2>
<p>Reusable step implementations live in <code>ace_next/steps/</code>. Each is a single class in a single file. All satisfy the <code>StepProtocol</code> from the pipeline engine. Each step does exactly one thing.</p>
<p><strong>Design principle: steps are stateless.</strong> A step's <code>__call__</code> is a pure function of its constructor arguments and the incoming <code>ACEStepContext</code>. No internal counters, no accumulated state between invocations. If a step needs run-scoped information (like a global sample index for interval logic), the runner computes it and places it on the context. This keeps steps predictable across multiple <code>run()</code> calls — behaviour depends only on what's in the context, not on invocation history.</p>
<h3 id="step-summary">Step Summary<a class="headerlink" href="#step-summary" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Step</th>
<th>Requires (context)</th>
<th>Injected (constructor)</th>
<th>Provides</th>
<th>Side effects</th>
<th><code>max_workers</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>AgentStep</strong></td>
<td><code>sample</code>, <code>skillbook</code></td>
<td><code>agent</code></td>
<td><code>agent_output</code></td>
<td>None</td>
<td>default (1)</td>
</tr>
<tr>
<td><strong>EvaluateStep</strong></td>
<td><code>sample</code>, <code>agent_output</code></td>
<td><code>environment</code> (optional)</td>
<td><code>trace</code></td>
<td>None</td>
<td>default (1)</td>
</tr>
<tr>
<td><strong>ReflectStep</strong></td>
<td><code>trace</code>, <code>skillbook</code></td>
<td><code>reflector</code></td>
<td><code>reflection</code></td>
<td>None (pure)</td>
<td>3; <code>async_boundary = True</code></td>
</tr>
<tr>
<td><strong>TagStep</strong></td>
<td><code>reflection</code></td>
<td><code>skillbook</code> (real)</td>
<td>—</td>
<td>Tags skills on skillbook</td>
<td>1</td>
</tr>
<tr>
<td><strong>UpdateStep</strong></td>
<td><code>reflection</code>, <code>skillbook</code></td>
<td><code>skill_manager</code></td>
<td><code>skill_manager_output</code></td>
<td>None (pure)</td>
<td>1</td>
</tr>
<tr>
<td><strong>ApplyStep</strong></td>
<td><code>skill_manager_output</code></td>
<td><code>skillbook</code> (real)</td>
<td>—</td>
<td>Applies update batch to skillbook</td>
<td>1</td>
</tr>
<tr>
<td><strong>DeduplicateStep</strong></td>
<td><code>global_sample_index</code></td>
<td><code>manager</code> (DeduplicationManagerLike), <code>skillbook</code> (real)</td>
<td>—</td>
<td>Consolidates similar skills</td>
<td>1</td>
</tr>
<tr>
<td><strong>CheckpointStep</strong></td>
<td><code>global_sample_index</code></td>
<td><code>skillbook</code> (real)</td>
<td>—</td>
<td>Saves skillbook to disk</td>
<td>1</td>
</tr>
<tr>
<td><strong>OpikStep</strong></td>
<td><code>skillbook</code></td>
<td><code>project_name</code>, <code>tags</code></td>
<td>—</td>
<td>Logs pipeline traces to Opik</td>
<td>1</td>
</tr>
<tr>
<td><strong>LoadTracesStep</strong></td>
<td><code>sample</code></td>
<td>—</td>
<td><code>trace</code></td>
<td>None (pure)</td>
<td>default (1)</td>
</tr>
<tr>
<td><strong>OpenClawToTraceStep</strong></td>
<td><code>trace</code></td>
<td>—</td>
<td><code>trace</code></td>
<td>None (pure)</td>
<td>default (1)</td>
</tr>
<tr>
<td><strong>PersistStep</strong></td>
<td><code>skillbook</code></td>
<td><code>target_path</code></td>
<td>—</td>
<td>Writes skillbook to CLAUDE.md or similar</td>
<td>1</td>
</tr>
<tr>
<td><strong>ExportSkillbookMarkdownStep</strong></td>
<td><code>skillbook</code></td>
<td><code>path</code>, <code>skillbook</code> (real)</td>
<td>—</td>
<td>Rewrites human-readable markdown file from skillbook</td>
<td>1</td>
</tr>
</tbody>
</table>
<p><strong>Requires vs Injected:</strong> <code>Requires</code> lists context fields read by the step — validated by the pipeline engine at construction time. The <code>skillbook</code> field on the context is a <code>SkillbookView</code> (read-only). Steps that <strong>write</strong> to the skillbook (TagStep, ApplyStep, DeduplicateStep, CheckpointStep) receive the real <code>Skillbook</code> via constructor injection — marked as "(real)" in the table. These injected dependencies are not tracked by <code>requires</code>/<code>provides</code>.</p>
<p><strong><code>trace</code> as the universal learning input:</strong> The learning tail's <em>entry point</em> (ReflectStep) requires only <code>trace</code> and <code>skillbook</code> from the context — subsequent steps in the tail chain off ReflectStep's output (<code>reflection</code>). In the standard ACE pipeline, <code>EvaluateStep</code> bundles the structured fields (<code>sample</code>, <code>agent_output</code>, and optionally environment feedback) into a <code>trace</code> dict. In TraceAnalyser, <code>_build_context</code> places the raw trace directly. In integrations, the execute step provides <code>trace</code> from its framework's native output. This means the learning tail is agnostic to trace format — <code>ReflectStep</code> passes <code>ctx.trace</code> to the Reflector, which is responsible for making sense of whatever it receives.</p>
<p>Steps with <code>provides = —</code> are pure side-effect steps (<code>provides = frozenset()</code>). They mutate shared state (skillbook) or write to external systems (disk, Opik) but add no new fields to the context. <code>OpikStep</code> is not included in <code>learning_tail()</code> — users append it explicitly to keep observability decoupled from core learning.</p>
<h3 id="agentstep">AgentStep<a class="headerlink" href="#agentstep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentStep</span><span class="p">:</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;agent_output&quot;</span><span class="p">})</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">:</span> <span class="n">AgentLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">agent</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>        <span class="n">agent_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>            <span class="n">question</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">question</span><span class="p">,</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>            <span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>            <span class="n">skillbook</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">skillbook</span><span class="p">,</span>       <span class="c1"># SkillbookView (read-only)</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>            <span class="n">sample</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>        <span class="p">)</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">agent_output</span><span class="o">=</span><span class="n">agent_output</span><span class="p">)</span>
</code></pre></div>
<p>Reads the skillbook via <code>ctx.skillbook</code> (a <code>SkillbookView</code>). No constructor injection needed — read-only access is sufficient.</p>
<h3 id="evaluatestep">EvaluateStep<a class="headerlink" href="#evaluatestep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">EvaluateStep</span><span class="p">:</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;agent_output&quot;</span><span class="p">})</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">TaskEnvironment</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>        <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>            <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">question</span><span class="p">,</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>            <span class="s2">&quot;ground_truth&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">ground_truth</span><span class="p">,</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>            <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">agent_output</span><span class="o">.</span><span class="n">reasoning</span><span class="p">,</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">agent_output</span><span class="o">.</span><span class="n">final_answer</span><span class="p">,</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>            <span class="s2">&quot;skill_ids&quot;</span><span class="p">:</span> <span class="n">ctx</span><span class="o">.</span><span class="n">agent_output</span><span class="o">.</span><span class="n">skill_ids</span><span class="p">,</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>        <span class="p">}</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>                <span class="n">sample</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">agent_output</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">agent_output</span><span class="p">,</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>            <span class="p">)</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>            <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;feedback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">feedback</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
</code></pre></div>
<p>Bridges the execute head (typed ACE objects) to the learning tail (raw traces). Always bundles the structured fields into a <code>trace</code> dict. Optionally evaluates the agent output against a <code>TaskEnvironment</code> — when provided via constructor, the environment's feedback is included in the trace. When no environment is provided, the trace still contains the agent's output, question, context, and ground truth — the Reflector can learn from these directly. The <code>TaskEnvironment</code> is injected at construction time (not on the context) to keep the context free of per-runner dependencies. This also means different <code>ACE</code> instances can use different environments without changing the pipeline shape.</p>
<h3 id="reflectstep">ReflectStep<a class="headerlink" href="#reflectstep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ReflectStep</span><span class="p">:</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">,</span> <span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;reflection&quot;</span><span class="p">})</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="n">async_boundary</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reflector</span><span class="p">:</span> <span class="n">ReflectorLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reflector</span> <span class="o">=</span> <span class="n">reflector</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="n">trace</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">trace</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>            <span class="c1"># Structured trace from EvaluateStep — extract known fields</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>            <span class="n">agent_output</span> <span class="o">=</span> <span class="n">AgentOutput</span><span class="p">(</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>                <span class="n">reasoning</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reasoning&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>                <span class="n">final_answer</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>                <span class="n">skill_ids</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skill_ids&quot;</span><span class="p">,</span> <span class="p">[]),</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>            <span class="p">)</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>            <span class="n">reflection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflector</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>                <span class="n">question</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>                <span class="n">agent_output</span><span class="o">=</span><span class="n">agent_output</span><span class="p">,</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>                <span class="n">skillbook</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>                <span class="n">ground_truth</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ground_truth&quot;</span><span class="p">),</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>                <span class="n">feedback</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;feedback&quot;</span><span class="p">),</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>            <span class="p">)</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>            <span class="c1"># Raw trace from TraceAnalyser or integration — pass as-is</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>            <span class="n">reflection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reflector</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>                <span class="n">question</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>                <span class="n">agent_output</span><span class="o">=</span><span class="n">AgentOutput</span><span class="p">(</span><span class="n">reasoning</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">final_answer</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>                <span class="n">skillbook</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>                <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>            <span class="p">)</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">reflection</span><span class="o">=</span><span class="n">reflection</span><span class="p">)</span>
</code></pre></div>
<p>Pure — produces a reflection object, no side effects. Handles two trace formats: (1) when <code>ctx.trace</code> is a dict (from EvaluateStep or a ToTrace converter), it extracts known fields and calls the Reflector's existing API with typed arguments; (2) when <code>ctx.trace</code> is any other object (from TraceAnalyser or integrations without a converter), it passes the raw trace via <code>**kwargs</code> — the Reflector accepts it for protocol compatibility but does not forward it to the LLM. Integration-specific traces should always go through a ToTrace converter step that produces the standardised dict. Declares <code>async_boundary = True</code> — everything from here onward runs in a background thread pool. This lets the execute head return fast while learning continues.</p>
<h3 id="tagstep">TagStep<a class="headerlink" href="#tagstep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">TagStep</span><span class="p">:</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;reflection&quot;</span><span class="p">})</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">reflection</span><span class="o">.</span><span class="n">skill_tags</span><span class="p">:</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="o">.</span><span class="n">tag_skill</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;TagStep: skill_id </span><span class="si">%r</span><span class="s2"> not found, skipping tag </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>        <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div>
<p>Side-effect step — tags skills on <code>self.skillbook</code> (the real <code>Skillbook</code>, injected via constructor — not the <code>SkillbookView</code> on the context). <code>max_workers = 1</code> serialises skillbook writes. Hallucinated skill IDs from the Reflector are logged at <code>WARNING</code> level rather than silently swallowed — this provides a diagnostic signal without aborting the pipeline.</p>
<p>Separated from ReflectStep so that:
- ReflectStep is a pure function (LLM call → reflection object) and can be tested without a skillbook.
- TagStep can be tested with a mock reflection without an LLM.</p>
<h3 id="updatestep">UpdateStep<a class="headerlink" href="#updatestep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">UpdateStep</span><span class="p">:</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;reflection&quot;</span><span class="p">,</span> <span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;skill_manager_output&quot;</span><span class="p">})</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>    <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">:</span> <span class="n">SkillManagerLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skill_manager</span> <span class="o">=</span> <span class="n">skill_manager</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skill_manager</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>            <span class="n">reflection</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">reflection</span><span class="p">,</span>     <span class="c1"># ReflectorOutput</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>            <span class="n">skillbook</span><span class="o">=</span><span class="n">ctx</span><span class="o">.</span><span class="n">skillbook</span><span class="p">,</span>       <span class="c1"># SkillbookView (read-only)</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>        <span class="p">)</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">skill_manager_output</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
</code></pre></div>
<p>Pure — generates update operations from the <code>ReflectorOutput</code> and the current skillbook state. The Reflector has already done the heavy lifting of analysing the trace; the SkillManager turns those insights into concrete skillbook operations (ADD, UPDATE, TAG, REMOVE). Does not mutate the skillbook. <code>max_workers = 1</code> because the skill manager reads the current skillbook state and concurrent calls would see stale data.</p>
<h3 id="applystep">ApplyStep<a class="headerlink" href="#applystep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ApplyStep</span><span class="p">:</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;skill_manager_output&quot;</span><span class="p">})</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="o">.</span><span class="n">apply_update</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">skill_manager_output</span><span class="p">)</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>        <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div>
<p>Side-effect step — applies the update batch to <code>self.skillbook</code> (the real <code>Skillbook</code>, injected via constructor). Separated from UpdateStep so that:
- UpdateStep can be tested without mutating a skillbook (check that correct operations are generated).
- ApplyStep can be tested with a mock update batch (check that operations are applied correctly).</p>
<h3 id="deduplicatestep">DeduplicateStep<a class="headerlink" href="#deduplicatestep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">DeduplicateStep</span><span class="p">:</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;global_sample_index&quot;</span><span class="p">})</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="n">max_workers</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">DeduplicationManagerLike</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">global_sample_index</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>            <span class="k">return</span> <span class="n">ctx</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">get_similarity_report</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="p">)</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DeduplicateStep: similarity report at sample </span><span class="si">%d</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>                        <span class="n">ctx</span><span class="o">.</span><span class="n">global_sample_index</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>        <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div>
<p>Optional side-effect step — consolidates similar skills in <code>self.skillbook</code> (injected). Appended to the pipeline by factory methods when a <code>DeduplicationManagerLike</code> is provided. The step takes a protocol, not the concrete <code>DeduplicationManager</code> — this keeps <code>ace_next</code> decoupled from the deduplication implementation in <code>ace/</code>. Stateless — uses <code>ctx.global_sample_index</code> (computed by the runner) with a configurable <code>interval</code> (default 10) to skip most invocations. Deduplication involves O(n²) similarity comparisons across all skills, so running it on every sample would be expensive as the skillbook grows.</p>
<h3 id="checkpointstep">CheckpointStep<a class="headerlink" href="#checkpointstep" title="Permanent link">&para;</a></h3>
<p>Optional tail step that periodically saves the skillbook to disk. Stateless — derives the checkpoint decision from context fields.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">CheckpointStep</span><span class="p">:</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;global_sample_index&quot;</span><span class="p">})</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>        <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">global_sample_index</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>            <span class="k">return</span> <span class="n">ctx</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;checkpoint_</span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">global_sample_index</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">))</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">/</span> <span class="s2">&quot;latest.json&quot;</span><span class="p">))</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>        <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div>
<p>Key points:
- <strong>Stateless.</strong> Uses <code>ctx.global_sample_index</code> (computed by the runner) for interval logic. No internal counter, no reset needed.
- <strong><code>provides</code> is empty</strong> — it only writes to disk, does not modify the context.
- <strong>Skillbook via constructor</strong> — saves <code>self.skillbook</code>, not a context field.
- <strong>Placement:</strong> Appended after ApplyStep by the factory when <code>checkpoint_dir</code> is provided. When <code>async_boundary</code> is set, checkpoints happen in the background tail.
- <strong><code>max_workers</code> not set</strong> — inherits default of 1 from the pipeline engine, which is correct (disk writes should be serialised).</p>
<h3 id="opikstep">OpikStep<a class="headerlink" href="#opikstep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">OpikStep</span><span class="p">:</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>        <span class="n">project_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ace-framework&quot;</span><span class="p">,</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>        <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</code></pre></div>
<p>Explicit, opt-in observability step — creates an Opik trace per sample with pipeline metadata, agent output, reflection insights, and skill manager operations. <strong>Does NOT register the LiteLLM callback</strong> — call <code>register_opik_litellm_callback()</code> separately if you also want per-LLM-call token/cost tracking. Two independent tracing modes: (1) pipeline step (this class) — client-agnostic, reads <code>ACEStepContext</code> fields; (2) LiteLLM callback (<code>register_opik_litellm_callback</code>) — LiteLLM-specific, registers <code>OpikLogger</code> on <code>litellm.callbacks</code>.</p>
<p>Only requires <code>skillbook</code> (always present). Reads other context fields (<code>reflection</code>, <code>skill_manager_output</code>, <code>trace</code>, <code>agent_output</code>) with guards — they may or may not be populated depending on pipeline shape. When used directly, gracefully degrades to a no-op when Opik is not installed or <code>OPIK_DISABLED=true</code>. When used via <code>ACELiteLLM(opik=True)</code>, <strong>fails loudly</strong> — raises <code>ImportError</code> if the package is missing, <code>RuntimeError</code> if client init fails.</p>
<p>Passes <code>OPIK_API_KEY</code>, <code>OPIK_WORKSPACE</code>, and <code>OPIK_URL_OVERRIDE</code> explicitly from environment variables — does <strong>not</strong> depend on the global <code>~/.opik.config</code> file.</p>
<p>Call <code>flush()</code> after the pipeline finishes to drain buffered traces before the process exits (the Opik client batches sends asynchronously).</p>
<p><strong>Not wired into <code>learning_tail()</code>.</strong> Users append it via <code>extra_steps</code> on <code>from_roles()</code>, or manually after calling <code>learning_tail()</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpikStep</span><span class="p">,</span> <span class="n">learning_tail</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="c1"># Append to a custom pipeline</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>    <span class="n">MyExecuteStep</span><span class="p">(</span><span class="n">agent</span><span class="p">),</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>    <span class="n">MyToTrace</span><span class="p">(),</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>    <span class="o">*</span><span class="n">learning_tail</span><span class="p">(</span><span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">),</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>    <span class="n">OpikStep</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="s2">&quot;my-project&quot;</span><span class="p">),</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="p">]</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="c1"># Via from_roles() extra_steps parameter</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">reflector</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">skill_manager</span><span class="o">=</span><span class="n">sm</span><span class="p">,</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>                     <span class="n">extra_steps</span><span class="o">=</span><span class="p">[</span><span class="n">OpikStep</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="s2">&quot;my-project&quot;</span><span class="p">)])</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="c1"># Via ACELiteLLM (explicit opt-in — enables both pipeline + LiteLLM tracing)</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACELiteLLM</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">opik</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opik_project</span><span class="o">=</span><span class="s2">&quot;my-project&quot;</span><span class="p">)</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="c1"># LLM-level token tracking only (no pipeline traces)</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_opik_litellm_callback</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="n">register_opik_litellm_callback</span><span class="p">()</span>
</code></pre></div>
<h3 id="loadtracesstep">LoadTracesStep<a class="headerlink" href="#loadtracesstep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoadTracesStep</span><span class="p">:</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;sample&quot;</span><span class="p">})</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">sample</span><span class="p">)</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>        <span class="n">events</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>                <span class="k">continue</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>                <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>                <span class="k">continue</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">events</span><span class="p">)</span>
</code></pre></div>
<p>Generic JSONL file loader — reads a file path from <code>ctx.sample</code>, parses each line as JSON, and populates <code>ctx.trace</code> with the parsed event dicts. Designed for integration runners that learn from pre-recorded traces on disk (e.g., OpenClaw session transcripts). Silently skips unparseable lines (blank lines, corrupted JSON). Returns an empty list for missing or empty files. Pure function — no constructor dependencies, no side effects.</p>
<p><strong>Placement:</strong> Used as the first step in trace-file-based pipelines, before a framework-specific ToTrace converter:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>    <span class="n">LoadTracesStep</span><span class="p">(),</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>    <span class="n">OpenClawToTraceStep</span><span class="p">(),</span>  <span class="c1"># or any ToTrace converter</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>    <span class="o">*</span><span class="n">learning_tail</span><span class="p">(</span><span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">),</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="p">]</span>
</code></pre></div>
<h3 id="openclawtotracestep">OpenClawToTraceStep<a class="headerlink" href="#openclawtotracestep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">OpenClawToTraceStep</span><span class="p">:</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>        <span class="n">events</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">trace</span>  <span class="c1"># list[dict] from LoadTracesStep</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>        <span class="n">trace_dict</span> <span class="o">=</span> <span class="n">_events_to_trace</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">trace_dict</span><span class="p">)</span>
</code></pre></div>
<p>OpenClaw-specific trace converter — transforms raw JSONL events (loaded by <code>LoadTracesStep</code>) into the structured trace format expected by <code>ReflectStep</code>. Extracts user messages into <code>question</code>, assistant thinking/tool calls/responses into <code>reasoning</code>, last assistant text into <code>answer</code>, and a session summary into <code>feedback</code>. Follows the same pattern as <code>BrowserToTrace</code>, <code>LangChainToTrace</code>, and <code>ClaudeCodeToTrace</code>. Lives in <code>ace_next/integrations/openclaw/to_trace.py</code>.</p>
<p><strong>Placement:</strong> Used after <code>LoadTracesStep</code> in OpenClaw pipelines. The <code>examples/openclaw/learn_from_traces.py</code> script uses both steps standalone (not in a full Pipeline) and feeds results to <code>TraceAnalyser.from_roles()</code>.</p>
<h3 id="persiststep">PersistStep<a class="headerlink" href="#persiststep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">PersistStep</span><span class="p">:</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">target_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_path</span><span class="p">)</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_path</span><span class="p">))</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>        <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div>
<p>Integration-specific side-effect step — writes the current skillbook to an external file (e.g., <code>CLAUDE.md</code> for Claude Code). Used by <code>ClaudeCode</code> runner to persist learned strategies into the project's instruction file after each learning cycle. Unlike <code>CheckpointStep</code> (which saves the full skillbook JSON at intervals), <code>PersistStep</code> runs on every sample and writes in the target format expected by the integration. Receives the real <code>Skillbook</code> via constructor injection.</p>
<h3 id="exportskillbookmarkdownstep">ExportSkillbookMarkdownStep<a class="headerlink" href="#exportskillbookmarkdownstep" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExportSkillbookMarkdownStep</span><span class="p">:</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>        <span class="c1"># Rewrites the markdown file from the current skillbook state</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a>        <span class="o">...</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a>        <span class="k">return</span> <span class="n">ctx</span>
</code></pre></div>
<p>Exports the skillbook as a human-readable markdown file, grouped by section. The file is rewritten from scratch on every invocation so it always reflects the current skillbook state. Intended for use as an <code>extra_step</code> appended after the learning tail. Receives the real <code>Skillbook</code> via constructor injection.</p>
<hr />
<h2 id="implementations">Implementations<a class="headerlink" href="#implementations" title="Permanent link">&para;</a></h2>
<p>Concrete LLM-based implementations of the role protocols. Live in <code>ace_next/implementations/</code> — fully self-contained with no imports from <code>ace/</code>.</p>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Class</th>
<th>Protocol</th>
<th>Method</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Agent</code></td>
<td><code>AgentLike</code></td>
<td><code>generate()</code></td>
<td><code>implementations/agent.py</code></td>
</tr>
<tr>
<td><code>Reflector</code></td>
<td><code>ReflectorLike</code></td>
<td><code>reflect()</code></td>
<td><code>implementations/reflector.py</code></td>
</tr>
<tr>
<td><code>SkillManager</code></td>
<td><code>SkillManagerLike</code></td>
<td><code>update_skills()</code></td>
<td><code>implementations/skill_manager.py</code></td>
</tr>
</tbody>
</table>
<p>All three share the same constructor pattern:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">LLMClientLike</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_PROMPT</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</code></pre></div>
<p>The <code>llm</code> parameter must satisfy <code>LLMClientLike</code> — it must have both <code>complete()</code> and <code>complete_structured()</code>. No auto-wrapping with Instructor; callers pass pre-wrapped clients.</p>
<h3 id="agent">Agent<a class="headerlink" href="#agent" title="Permanent link">&para;</a></h3>
<p>Produces answers using the current skillbook of strategies. Formats the prompt with the skillbook, reflection, question, and context, then calls <code>llm.complete_structured(prompt, AgentOutput)</code>. After the LLM call, extracts cited skill IDs from the reasoning using <code>extract_cited_skill_ids()</code> (regex matching <code>[section-00001]</code> patterns).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">output</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>    <span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is the capital of France?&quot;</span><span class="p">,</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>    <span class="n">context</span><span class="o">=</span><span class="s2">&quot;Answer concisely&quot;</span><span class="p">,</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>    <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="p">)</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="c1"># output.final_answer == &quot;Paris&quot;</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="c1"># output.skill_ids == [&quot;geography-00001&quot;]  (extracted from reasoning)</span>
</code></pre></div>
<h3 id="reflector">Reflector<a class="headerlink" href="#reflector" title="Permanent link">&para;</a></h3>
<p>Analyzes agent outputs to extract lessons and improve strategies. Builds a skillbook excerpt from the agent's cited skill IDs (via <code>make_skillbook_excerpt()</code>), formats the prompt, and calls <code>llm.complete_structured(prompt, ReflectorOutput)</code>.</p>
<p><strong>SIMPLE mode only</strong> — single-pass reflection. Recursive mode (where the Reflector iterates multiple times to deepen analysis) is an advanced feature deferred to a later version.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">reflector</span> <span class="o">=</span> <span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">reflection</span> <span class="o">=</span> <span class="n">reflector</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>    <span class="n">question</span><span class="o">=</span><span class="s2">&quot;What is 2+2?&quot;</span><span class="p">,</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="n">agent_output</span><span class="o">=</span><span class="n">agent_output</span><span class="p">,</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>    <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>    <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;4&quot;</span><span class="p">,</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>    <span class="n">feedback</span><span class="o">=</span><span class="s2">&quot;Correct!&quot;</span><span class="p">,</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="p">)</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="c1"># reflection.key_insight, reflection.skill_tags, reflection.extracted_learnings</span>
</code></pre></div>
<h3 id="skillmanager">SkillManager<a class="headerlink" href="#skillmanager" title="Permanent link">&para;</a></h3>
<p>Transforms reflections into actionable skillbook updates. Serializes the <code>ReflectorOutput</code> into a JSON dict, formats the prompt with progress and skillbook stats, and calls <code>llm.complete_structured(prompt, SkillManagerOutput)</code>.</p>
<p><strong>No dedup integration</strong> — in <code>ace_next</code>, deduplication is handled by a separate <code>DeduplicateStep</code> in the pipeline. The SkillManager only produces <code>SkillManagerOutput</code>; it does not call a dedup manager itself.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">sm</span> <span class="o">=</span> <span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">output</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">update_skills</span><span class="p">(</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>    <span class="n">reflection</span><span class="o">=</span><span class="n">reflection_output</span><span class="p">,</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>    <span class="n">question_context</span><span class="o">=</span><span class="s2">&quot;Math problem solving&quot;</span><span class="p">,</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>    <span class="n">progress</span><span class="o">=</span><span class="s2">&quot;5/10 correct&quot;</span><span class="p">,</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="p">)</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="n">skillbook</span><span class="o">.</span><span class="n">apply_update</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
</code></pre></div>
<h3 id="shared-helpers-implementationshelperspy">Shared Helpers (<code>implementations/helpers.py</code>)<a class="headerlink" href="#shared-helpers-implementationshelperspy" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>extract_cited_skill_ids(text)</code></td>
<td>Regex <code>[section-00001]</code> → deduplicated list of IDs</td>
</tr>
<tr>
<td><code>format_optional(value)</code></td>
<td>Returns <code>"(none)"</code> for falsy values</td>
</tr>
<tr>
<td><code>make_skillbook_excerpt(skillbook, skill_ids)</code></td>
<td>Builds <code>[id] content</code> lines for cited skills</td>
</tr>
</tbody>
</table>
<h3 id="prompt-templates-implementationspromptspy">Prompt Templates (<code>implementations/prompts.py</code>)<a class="headerlink" href="#prompt-templates-implementationspromptspy" title="Permanent link">&para;</a></h3>
<p>Self-contained copy of the v2.1 prompts from <code>ace/prompts_v2_1.py</code>. The <code>{current_date}</code> placeholder is filled at import time via <code>datetime.now().strftime(...)</code>.</p>
<table>
<thead>
<tr>
<th>Constant</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AGENT_PROMPT</code></td>
<td>Agent prompt with strategic problem-solving protocol</td>
</tr>
<tr>
<td><code>REFLECTOR_PROMPT</code></td>
<td>Reflector prompt with diagnostic analysis protocol</td>
</tr>
<tr>
<td><code>SKILL_MANAGER_PROMPT</code></td>
<td>SkillManager prompt with atomic strategy creation</td>
</tr>
<tr>
<td><code>SKILLBOOK_USAGE_INSTRUCTIONS</code></td>
<td>Shared text for skillbook usage guidance</td>
</tr>
</tbody>
</table>
<p>Also exports <code>wrap_skillbook_for_external_agent(skillbook)</code> — the canonical function for injecting skillbook context into external agentic systems.</p>
<hr />
<h2 id="deduplication">Deduplication<a class="headerlink" href="#deduplication" title="Permanent link">&para;</a></h2>
<p>Skill deduplication subsystem. Lives in <code>ace_next/deduplication/</code> — fully self-contained with no imports from <code>ace/</code>.</p>
<h3 id="overview_1">Overview<a class="headerlink" href="#overview_1" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Class</th>
<th>Role</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SimilarityDetector</code></td>
<td>Computes embeddings, detects similar pairs</td>
<td><code>deduplication/detector.py</code></td>
</tr>
<tr>
<td><code>DeduplicationManager</code></td>
<td>Coordinates detection and consolidation</td>
<td><code>deduplication/manager.py</code></td>
</tr>
<tr>
<td><code>MergeOp</code>, <code>DeleteOp</code>, <code>KeepOp</code>, <code>UpdateOp</code></td>
<td>Consolidation operation types</td>
<td><code>deduplication/operations.py</code></td>
</tr>
</tbody>
</table>
<h3 id="similaritydetector">SimilarityDetector<a class="headerlink" href="#similaritydetector" title="Permanent link">&para;</a></h3>
<p>Computes embeddings and detects similar skill pairs using cosine similarity. Supports two embedding providers:</p>
<ul>
<li><strong>LiteLLM</strong> — uses <code>litellm.embedding()</code> for remote embedding models</li>
<li><strong>sentence-transformers</strong> — uses a local <code>SentenceTransformer</code> model (lazy-loaded)</li>
</ul>
<p>Feature detection uses inline <code>importlib.import_module</code> checks instead of <code>ace.features</code>. Cosine similarity has a numpy implementation with a pure-Python fallback.</p>
<p>Key methods:
- <code>ensure_embeddings(skillbook)</code> — compute embeddings for all skills that lack one
- <code>detect_similar_pairs(skillbook, threshold)</code> — find all pairs above the similarity threshold
- Supports <code>within_section_only</code> mode (compare skills only within the same section)
- Respects existing <code>KEEP</code> decisions via <code>skillbook.has_keep_decision()</code></p>
<h3 id="deduplicationmanager">DeduplicationManager<a class="headerlink" href="#deduplicationmanager" title="Permanent link">&para;</a></h3>
<p>Satisfies <code>DeduplicationManagerLike</code> protocol. Coordinates the full dedup workflow:</p>
<ol>
<li><code>get_similarity_report(skillbook)</code> — ensures embeddings, detects similar pairs, generates a formatted report for the SkillManager prompt. Returns <code>None</code> if dedup is disabled or too few pairs found.</li>
<li><code>parse_consolidation_operations(response_data)</code> — parses <code>consolidation_operations</code> from SkillManager response JSON into typed operation objects.</li>
<li><code>apply_operations(operations, skillbook)</code> — applies consolidation operations to the skillbook.</li>
</ol>
<h3 id="consolidation-operations">Consolidation Operations<a class="headerlink" href="#consolidation-operations" title="Permanent link">&para;</a></h3>
<p>Four operation types, all dataclasses:</p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>MergeOp</code></td>
<td>Combine skills — accumulate counters into <code>keep_id</code>, soft-delete others, update content</td>
</tr>
<tr>
<td><code>DeleteOp</code></td>
<td>Soft-delete a redundant skill</td>
</tr>
<tr>
<td><code>KeepOp</code></td>
<td>Store a <code>SimilarityDecision</code> so the pair is not flagged again</td>
</tr>
<tr>
<td><code>UpdateOp</code></td>
<td>Refine a skill's content to differentiate it, clear its embedding</td>
</tr>
</tbody>
</table>
<p><code>apply_consolidation_operations(operations, skillbook)</code> dispatches each operation to the appropriate apply function.</p>
<h3 id="pipeline-integration">Pipeline Integration<a class="headerlink" href="#pipeline-integration" title="Permanent link">&para;</a></h3>
<p>Deduplication runs as a separate <code>DeduplicateStep</code> in the pipeline, not inside the SkillManager role. The step is appended by factory methods when a <code>DeduplicationManagerLike</code> is provided:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span> <span class="n">reflector</span><span class="o">=</span><span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="o">=</span><span class="n">skill_manager</span><span class="p">,</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>    <span class="n">dedup_manager</span><span class="o">=</span><span class="n">DeduplicationManager</span><span class="p">(</span><span class="n">DeduplicationConfig</span><span class="p">(</span><span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)),</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>    <span class="n">dedup_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="p">)</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="c1"># Pipeline: Agent → Evaluate → Reflect → Tag → Update → Apply → Deduplicate</span>
</code></pre></div>
<hr />
<h2 id="integration-pattern">Integration Pattern<a class="headerlink" href="#integration-pattern" title="Permanent link">&para;</a></h2>
<p>External frameworks (browser-use, LangChain, Claude Code) integrate via composable pipeline steps in <code>ace_next/integrations/</code>. Each integration provides three things:</p>
<ol>
<li><strong>Result type</strong> — an integration-specific dataclass (e.g. <code>BrowserResult</code>, <code>ClaudeCodeResult</code>)</li>
<li><strong>Execute step</strong> — INJECT skillbook context + EXECUTE the framework, writes the result to <code>ctx.trace</code></li>
<li><strong>ToTrace step</strong> — converts the integration-specific result into the standardised trace dict that <code>ReflectStep</code> expects</li>
</ol>
<p>Runners in <code>ace_next/runners/</code> compose these steps with <code>learning_tail()</code>.</p>
<h3 id="core-idea-execute-convert-learn">Core idea: execute → convert → learn<a class="headerlink" href="#core-idea-execute-convert-learn" title="Permanent link">&para;</a></h3>
<p>Each integration defines its own input/output format. A converter step acts as a compatibility layer between the integration-specific result and the learning tail's standardised trace dict.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>Standard ACE:      [Agent → Evaluate]                          → [Reflect → Tag → Update → Apply]
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>                    ╰── execute (built-in) ──╯                    ╰──────── learn (shared) ──────╯
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>                         provides: trace (dict) ─────────────────► requires: trace
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>Browser-use:       [BrowserExecute] → [BrowserToTrace]         → [Reflect → Tag → Update → Apply]
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>                    ╰── execute ────╯   ╰── convert ──╯           ╰──────── learn (shared) ──────╯
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>                    provides: trace      rewrites trace             requires: trace
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>                    (BrowserResult)      (BrowserResult → dict)
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>TraceAnalyser:     [_build_context]                            → [Reflect → Tag → Update → Apply]
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>                    ╰── sets ctx.trace (raw object) ───────╯      ╰──────── learn (shared) ──────╯
</code></pre></div>
<p>The execute step writes an integration-specific result type to <code>ctx.trace</code>. The ToTrace step reads that result and rewrites <code>ctx.trace</code> with a standardised dict. The learning tail only ever sees the dict.</p>
<h3 id="two-step-contract">Two-step contract<a class="headerlink" href="#two-step-contract" title="Permanent link">&para;</a></h3>
<p>Every integration provides two steps that chain together:</p>
<p><strong>Step 1 — Execute step</strong> (INJECT + EXECUTE):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SomeExecuteStep</span><span class="p">:</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framework_client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">framework_client</span> <span class="o">=</span> <span class="n">framework_client</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sample</span>                               <span class="c1"># raw input (string, dict, etc.)</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>        <span class="n">enhanced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inject</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">skillbook</span><span class="p">)</span>    <span class="c1"># prepend skillbook context</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">framework_client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">enhanced</span><span class="p">)</span>    <span class="c1"># framework-specific execution</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">SomeResult</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>       <span class="c1"># integration-specific result type</span>
</code></pre></div>
<p><strong>Step 2 — ToTrace step</strong> (convert to standardised dict):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">SomeToTrace</span><span class="p">:</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>         <span class="c1"># overwrites trace with standardised dict</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>        <span class="n">r</span><span class="p">:</span> <span class="n">SomeResult</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">trace</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>        <span class="n">trace</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>            <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>            <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">execution_trace</span><span class="p">,</span>     <span class="c1"># integration-specific formatting</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>            <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>            <span class="s2">&quot;skill_ids&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">cited_skill_ids</span><span class="p">,</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>            <span class="s2">&quot;feedback&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="s1">&#39;succeeded&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="o">.</span><span class="n">success</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;failed&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>            <span class="s2">&quot;ground_truth&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>        <span class="p">}</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">)</span>
</code></pre></div>
<p>The standardised trace dict keys match what <code>ReflectStep</code> expects: <code>question</code>, <code>reasoning</code>, <code>answer</code>, <code>skill_ids</code>, <code>feedback</code>, <code>ground_truth</code>.</p>
<h3 id="why-two-steps-instead-of-one">Why two steps instead of one<a class="headerlink" href="#why-two-steps-instead-of-one" title="Permanent link">&para;</a></h3>
<p>Splitting execute from trace conversion gives three benefits:</p>
<ol>
<li><strong>Independent testability</strong> — test the execute step with a mock framework without worrying about trace format; test the ToTrace step with a fixture result without running a real framework.</li>
<li><strong>Reusability</strong> — the execute step can be used standalone (without learning) to get framework-specific results. The ToTrace step can be swapped for a custom converter.</li>
<li><strong>Separation of concerns</strong> — framework interaction logic stays in the execute step; trace formatting stays in the converter. Neither knows about the other's internals.</li>
</ol>
<h3 id="result-types">Result types<a class="headerlink" href="#result-types" title="Permanent link">&para;</a></h3>
<p>Each integration defines its own result dataclass:</p>
<table>
<thead>
<tr>
<th>Integration</th>
<th>Result type</th>
<th>Key fields</th>
</tr>
</thead>
<tbody>
<tr>
<td>Browser-use</td>
<td><code>BrowserResult</code></td>
<td><code>task</code>, <code>success</code>, <code>output</code>, <code>error</code>, <code>steps_count</code>, <code>duration_seconds</code>, <code>cited_skill_ids</code>, <code>chronological_steps</code>, <code>raw_history</code></td>
</tr>
<tr>
<td>Claude Code</td>
<td><code>ClaudeCodeResult</code></td>
<td><code>task</code>, <code>success</code>, <code>output</code>, <code>execution_trace</code>, <code>returncode</code>, <code>error</code></td>
</tr>
<tr>
<td>LangChain</td>
<td><code>LangChainResult</code></td>
<td><code>task</code>, <code>output</code>, <code>result_type</code> (simple/agent/langgraph/error), <code>success</code>, <code>error</code>, <code>intermediate_steps</code>, <code>messages</code>, <code>raw_result</code></td>
</tr>
</tbody>
</table>
<h3 id="example-browser-use-execute-step">Example — browser-use execute step<a class="headerlink" href="#example-browser-use-execute-step" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BrowserExecuteStep</span><span class="p">:</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>    <span class="n">requires</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;skillbook&quot;</span><span class="p">})</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>    <span class="n">provides</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;trace&quot;</span><span class="p">})</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">browser_llm</span><span class="p">,</span> <span class="n">browser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">agent_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">browser_llm</span> <span class="o">=</span> <span class="n">browser_llm</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">browser</span> <span class="o">=</span> <span class="n">browser</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_kwargs</span> <span class="o">=</span> <span class="n">agent_kwargs</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">ACEStepContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACEStepContext</span><span class="p">:</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">sample</span>      <span class="c1"># raw task string, not a Sample object</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>        <span class="c1"># INJECT — prepend skillbook context</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>        <span class="n">enhanced_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inject</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">skillbook</span><span class="p">)</span>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>        <span class="c1"># EXECUTE — run browser-use agent</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>        <span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">enhanced_task</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">browser_llm</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_kwargs</span><span class="p">)</span>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>        <span class="n">history</span> <span class="o">=</span> <span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>        <span class="c1"># Build integration-specific result</span>
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">BrowserResult</span><span class="p">(</span>
<a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a>            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">history</span><span class="o">.</span><span class="n">final_result</span><span class="p">(),</span>
<a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a>            <span class="n">steps_count</span><span class="o">=</span><span class="n">history</span><span class="o">.</span><span class="n">number_of_steps</span><span class="p">(),</span>
<a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a>            <span class="n">chronological_steps</span><span class="o">=...</span><span class="p">,</span> <span class="n">raw_history</span><span class="o">=</span><span class="n">history</span><span class="p">,</span>
<a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a>        <span class="p">)</span>
<a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a>        <span class="k">return</span> <span class="n">ctx</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">trace</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>
<h3 id="composing-into-a-runner">Composing into a runner<a class="headerlink" href="#composing-into-a-runner" title="Permanent link">&para;</a></h3>
<p>Runners compose execute step + ToTrace step + learning tail:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BrowserUse</span><span class="p">(</span><span class="n">ACERunner</span><span class="p">):</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Browser-use agent with ACE learning pipeline.&quot;&quot;&quot;</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_roles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">browser_llm</span><span class="p">,</span> <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>                   <span class="n">skillbook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>        <span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span> <span class="ow">or</span> <span class="n">Skillbook</span><span class="p">()</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a>        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>            <span class="n">BrowserExecuteStep</span><span class="p">(</span><span class="n">browser_llm</span><span class="p">),</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>            <span class="n">BrowserToTrace</span><span class="p">(),</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a>            <span class="o">*</span><span class="n">learning_tail</span><span class="p">(</span><span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>        <span class="p">]</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">)</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">total_epochs</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a>                       <span class="n">global_sample_index</span><span class="p">,</span> <span class="o">**</span><span class="n">_</span><span class="p">):</span>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a>        <span class="k">return</span> <span class="n">ACEStepContext</span><span class="p">(</span>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a>            <span class="n">sample</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>    <span class="c1"># raw string — not wrapped in Sample</span>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a>            <span class="n">skillbook</span><span class="o">=</span><span class="n">SkillbookView</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skillbook</span><span class="p">),</span>
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a>            <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span><span class="p">,</span> <span class="n">total_epochs</span><span class="o">=</span><span class="n">total_epochs</span><span class="p">,</span>
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a>            <span class="n">step_index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">total_steps</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a>            <span class="n">global_sample_index</span><span class="o">=</span><span class="n">global_sample_index</span><span class="p">,</span>
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a>        <span class="p">)</span>
</code></pre></div>
<p>The pattern is the same for every integration: subclass <code>ACERunner</code>, compose <code>[ExecuteStep, ToTrace, *learning_tail()]</code> in the factory, accept raw inputs (strings, dicts) in <code>run()</code>, and map them to <code>ACEStepContext</code> in <code>_build_context()</code>. No <code>Sample</code> wrapping — the raw input goes directly on <code>ctx.sample</code>.</p>
<h3 id="learning_tail-reusable-learning-steps"><code>learning_tail()</code> — reusable learning steps<a class="headerlink" href="#learning_tail-reusable-learning-steps" title="Permanent link">&para;</a></h3>
<p>Every integration assembles the same <code>[Reflect → Tag → Update → Apply]</code> suffix with optional dedup and checkpoint steps. Rather than duplicating this wiring in every factory method, <code>learning_tail()</code> returns the standard step list:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c1"># ace_next/steps/__init__.py</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">learning_tail</span><span class="p">(</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>    <span class="n">reflector</span><span class="p">:</span> <span class="n">ReflectorLike</span><span class="p">,</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>    <span class="n">skill_manager</span><span class="p">:</span> <span class="n">SkillManagerLike</span><span class="p">,</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>    <span class="n">skillbook</span><span class="p">:</span> <span class="n">Skillbook</span><span class="p">,</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>    <span class="o">*</span><span class="p">,</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>    <span class="n">dedup_manager</span><span class="p">:</span> <span class="n">DeduplicationManagerLike</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>    <span class="n">dedup_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>    <span class="n">checkpoint_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a>    <span class="n">checkpoint_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">StepProtocol</span><span class="p">]:</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the standard ACE learning steps.</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="sd">    Use this when building custom integrations that provide their own</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="sd">    execute step(s) but want the standard learning pipeline.</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a>    <span class="n">steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">StepProtocol</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>        <span class="n">ReflectStep</span><span class="p">(</span><span class="n">reflector</span><span class="p">),</span>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a>        <span class="n">TagStep</span><span class="p">(</span><span class="n">skillbook</span><span class="p">),</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>        <span class="n">UpdateStep</span><span class="p">(</span><span class="n">skill_manager</span><span class="p">),</span>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a>        <span class="n">ApplyStep</span><span class="p">(</span><span class="n">skillbook</span><span class="p">),</span>
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a>    <span class="p">]</span>
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a>    <span class="k">if</span> <span class="n">dedup_manager</span><span class="p">:</span>
<a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a>        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DeduplicateStep</span><span class="p">(</span><span class="n">dedup_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">dedup_interval</span><span class="p">))</span>
<a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a>    <span class="k">if</span> <span class="n">checkpoint_dir</span><span class="p">:</span>
<a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a>        <span class="n">steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CheckpointStep</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">checkpoint_interval</span><span class="p">))</span>
<a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a>    <span class="k">return</span> <span class="n">steps</span>
</code></pre></div>
<p>Integration factories become shorter and less error-prone:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BrowserUse</span><span class="p">(</span><span class="n">ACERunner</span><span class="p">):</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_roles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">browser_llm</span><span class="p">,</span> <span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>        <span class="n">skillbook</span> <span class="o">=</span> <span class="n">skillbook</span> <span class="ow">or</span> <span class="n">Skillbook</span><span class="p">()</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>            <span class="n">BrowserExecuteStep</span><span class="p">(</span><span class="n">browser_llm</span><span class="p">),</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>            <span class="n">BrowserToTrace</span><span class="p">(),</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>            <span class="o">*</span><span class="n">learning_tail</span><span class="p">(</span><span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>        <span class="p">]</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pipeline</span><span class="o">=</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">)</span>
</code></pre></div>
<p>Power users building fully custom pipelines can also use it:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">learning_tail</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="n">skillbook</span> <span class="o">=</span> <span class="n">Skillbook</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="s2">&quot;expert.json&quot;</span><span class="p">)</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>    <span class="n">MyCustomExecuteStep</span><span class="p">(</span><span class="n">my_agent</span><span class="p">),</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>    <span class="n">MyValidationStep</span><span class="p">(),</span>  <span class="c1"># custom step before learning</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>    <span class="o">*</span><span class="n">learning_tail</span><span class="p">(</span><span class="n">reflector</span><span class="p">,</span> <span class="n">skill_manager</span><span class="p">,</span> <span class="n">skillbook</span><span class="p">,</span> <span class="n">dedup_manager</span><span class="o">=</span><span class="n">dedup</span><span class="p">),</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="p">]</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">ACERunner</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="n">skillbook</span><span class="p">)</span>
</code></pre></div>
<h3 id="traceanalyser-batch-learning-from-recorded-executions">TraceAnalyser — batch learning from recorded executions<a class="headerlink" href="#traceanalyser-batch-learning-from-recorded-executions" title="Permanent link">&para;</a></h3>
<p>Integrations also support offline learning. When an integration records execution history (browser-use AgentHistory, LangChain intermediate_steps, Claude Code transcripts), it feeds the raw objects directly to TraceAnalyser:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># Record browser executions</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="n">histories</span> <span class="o">=</span> <span class="p">[</span><span class="k">await</span> <span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="c1"># Feed raw histories directly — Reflector analyses them as-is</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="n">analyser</span> <span class="o">=</span> <span class="n">TraceAnalyser</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm_client</span><span class="p">),</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm_client</span><span class="p">),</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="p">)</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="n">analyser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="n">analyser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;browser_expert.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="live-vs-offline">Live vs offline<a class="headerlink" href="#live-vs-offline" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th></th>
<th>Integration Runner</th>
<th>TraceAnalyser</th>
</tr>
</thead>
<tbody>
<tr>
<td>When</td>
<td>Live execution</td>
<td>Post-hoc analysis</td>
</tr>
<tr>
<td>Agent</td>
<td>Framework runs it</td>
<td>Already ran</td>
</tr>
<tr>
<td>Feedback</td>
<td>Generated live</td>
<td>Baked into trace</td>
</tr>
<tr>
<td>Use case</td>
<td>Production deployment</td>
<td>Historical batch learning, debugging</td>
</tr>
</tbody>
</table>
<p>Both update the same skillbook. A common workflow: TraceAnalyser builds an initial skillbook from historical data, then an integration runner refines it during live deployment.</p>
<hr />
<h2 id="high-level-convenience-api">High-Level Convenience API<a class="headerlink" href="#high-level-convenience-api" title="Permanent link">&para;</a></h2>
<p>Integration runners provide two construction paths directly on the class — no separate wrapper classes needed:</p>
<ol>
<li><strong><code>from_roles()</code></strong> — accepts pre-built role instances (Reflector, SkillManager, etc.)</li>
<li><strong><code>from_model()</code></strong> — accepts a model string and auto-builds roles internally</li>
</ol>
<p>This keeps the API surface minimal: one class per integration, two ways to construct it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># Explicit construction — bring your own roles</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">BrowserUse</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">browser_llm</span><span class="o">=</span><span class="n">browser_llm</span><span class="p">,</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="p">)</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="c1"># Convenience construction — just specify the model</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">BrowserUse</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="n">browser_llm</span><span class="p">,</span> <span class="n">ace_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="c1"># Both return the same BrowserUse instance with the same API</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="n">results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;Find top HN post&quot;</span><span class="p">,</span> <span class="s2">&quot;Check weather in NYC&quot;</span><span class="p">])</span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="n">runner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;browser_expert.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="from_model-on-integration-runners"><code>from_model()</code> on integration runners<a class="headerlink" href="#from_model-on-integration-runners" title="Permanent link">&para;</a></h3>
<p>Each integration runner's <code>from_model()</code> builds a <code>LiteLLMClient</code>, wraps it in <code>Reflector</code> and <code>SkillManager</code>, and delegates to <code>from_roles()</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BrowserUse</span><span class="p">(</span><span class="n">ACERunner</span><span class="p">):</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">browser_llm</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ace_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>                   <span class="n">ace_max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">ace_llm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BrowserUse</span><span class="p">:</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>        <span class="k">if</span> <span class="n">ace_llm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">..providers</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLLMClient</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>            <span class="n">ace_llm</span> <span class="o">=</span> <span class="n">LiteLLMClient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">ace_model</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="n">ace_max_tokens</span><span class="p">)</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>            <span class="n">browser_llm</span><span class="o">=</span><span class="n">browser_llm</span><span class="p">,</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>            <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">ace_llm</span><span class="p">),</span>
<a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>            <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">ace_llm</span><span class="p">),</span>
<a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>        <span class="p">)</span>
</code></pre></div>
<p>The same pattern applies to <code>LangChain.from_model(runnable, ...)</code> and <code>ClaudeCode.from_model(working_dir=..., ...)</code>. Providers are imported lazily inside <code>from_model()</code> to avoid hard dependencies on <code>litellm</code> at import time.</p>
<h3 id="additional-convenience-on-from_roles">Additional convenience on <code>from_roles()</code><a class="headerlink" href="#additional-convenience-on-from_roles" title="Permanent link">&para;</a></h3>
<p>Integration runners also accept <code>skillbook_path</code> and <code>dedup_config</code> on <code>from_roles()</code> for common resolution patterns:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">BrowserUse</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>    <span class="n">browser_llm</span><span class="o">=</span><span class="n">browser_llm</span><span class="p">,</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">reflector</span><span class="p">,</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">skill_manager</span><span class="p">,</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>    <span class="n">skillbook_path</span><span class="o">=</span><span class="s2">&quot;browser_expert.json&quot;</span><span class="p">,</span>   <span class="c1"># loads skillbook from file</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>    <span class="n">dedup_config</span><span class="o">=</span><span class="n">DeduplicationConfig</span><span class="p">(</span><span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">),</span>  <span class="c1"># builds DeduplicationManager</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="p">)</span>
</code></pre></div>
<h3 id="convenience-lifecycle-methods-on-runners">Convenience lifecycle methods on runners<a class="headerlink" href="#convenience-lifecycle-methods-on-runners" title="Permanent link">&para;</a></h3>
<p>All integration runners provide:</p>
<ul>
<li><code>get_strategies() -&gt; str</code> — formatted skillbook strategies for display</li>
<li>Backward-compat aliases: <code>save_skillbook</code>, <code>load_skillbook</code>, <code>wait_for_learning</code></li>
</ul>
<p>These are defined directly on the runner class, not on a separate wrapper.</p>
<h3 id="acelitellm-standalone-convenience-wrapper"><code>ACELiteLLM</code> — standalone convenience wrapper<a class="headerlink" href="#acelitellm-standalone-convenience-wrapper" title="Permanent link">&para;</a></h3>
<p><code>ACELiteLLM</code> is the only standalone wrapper class (not an <code>ACERunner</code> subclass). It exists because it wraps two different runners (<code>ACE</code> and <code>TraceAnalyser</code>) and exposes a fundamentally different API (<code>ask</code>, <code>learn</code>, <code>learn_from_traces</code>, <code>learn_from_feedback</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ACELiteLLM</span><span class="p">:</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">skillbook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>                 <span class="n">opik</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opik_project</span><span class="o">=</span><span class="s2">&quot;ace-framework&quot;</span><span class="p">,</span> <span class="n">opik_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reflector</span> <span class="o">=</span> <span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">skill_manager</span> <span class="o">=</span> <span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_skillbook</span> <span class="o">=</span> <span class="n">skillbook</span> <span class="ow">or</span> <span class="n">Skillbook</span><span class="p">()</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ace</span><span class="p">:</span> <span class="n">ACE</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>          <span class="c1"># lazy-init</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_analyser</span><span class="p">:</span> <span class="n">TraceAnalyser</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># lazy-init</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>        <span class="c1"># Opik observability (explicit opt-in)</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_opik_step</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>        <span class="k">if</span> <span class="n">opik</span><span class="p">:</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_opik_step</span> <span class="o">=</span> <span class="n">OpikStep</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">opik_project</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">opik_tags</span><span class="p">)</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>            <span class="n">register_opik_litellm_callback</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">opik_project</span><span class="p">)</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a>                   <span class="n">temperature</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">opik</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">opik_project</span><span class="o">=</span><span class="s2">&quot;ace-framework&quot;</span><span class="p">,</span>
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>                   <span class="n">opik_tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ACELiteLLM</span><span class="p">:</span>
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Build from a model string.&quot;&quot;&quot;</span>
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a>        <span class="n">llm</span> <span class="o">=</span> <span class="n">LiteLLMClient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">opik</span><span class="o">=</span><span class="n">opik</span><span class="p">,</span> <span class="n">opik_project</span><span class="o">=</span><span class="n">opik_project</span><span class="p">,</span> <span class="n">opik_tags</span><span class="o">=</span><span class="n">opik_tags</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a>
<a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_extra_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return extra pipeline steps (e.g. OpikStep) or None.&quot;&quot;&quot;</span>
<a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opik_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a>            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_opik_step</span><span class="p">]</span>
<a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a>
<a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_ace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return (or build) cached ACE runner. Passes extra_steps.&quot;&quot;&quot;</span>
<a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a>        <span class="o">...</span>
<a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">extra_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_extra_steps</span><span class="p">())</span>
<a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a>        <span class="o">...</span>
<a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a>
<a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_analyser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return (or build) cached TraceAnalyser. Passes extra_steps.&quot;&quot;&quot;</span>
<a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a>        <span class="o">...</span>
<a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_analyser</span> <span class="o">=</span> <span class="n">TraceAnalyser</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">extra_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_extra_steps</span><span class="p">())</span>
<a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a>        <span class="o">...</span>
<a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a>
<a id="__codelineno-52-44" name="__codelineno-52-44" href="#__codelineno-52-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-52-45" name="__codelineno-52-45" href="#__codelineno-52-45"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Direct Agent call — no pipeline. Stores interaction for learn_from_feedback().&quot;&quot;&quot;</span>
<a id="__codelineno-52-46" name="__codelineno-52-46" href="#__codelineno-52-46"></a>        <span class="o">...</span>
<a id="__codelineno-52-47" name="__codelineno-52-47" href="#__codelineno-52-47"></a>
<a id="__codelineno-52-48" name="__codelineno-52-48" href="#__codelineno-52-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">learn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-52-49" name="__codelineno-52-49" href="#__codelineno-52-49"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delegate to lazy-init ACE runner.&quot;&quot;&quot;</span>
<a id="__codelineno-52-50" name="__codelineno-52-50" href="#__codelineno-52-50"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ace</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
<a id="__codelineno-52-51" name="__codelineno-52-51" href="#__codelineno-52-51"></a>
<a id="__codelineno-52-52" name="__codelineno-52-52" href="#__codelineno-52-52"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">learn_from_traces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-52-53" name="__codelineno-52-53" href="#__codelineno-52-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delegate to lazy-init TraceAnalyser.&quot;&quot;&quot;</span>
<a id="__codelineno-52-54" name="__codelineno-52-54" href="#__codelineno-52-54"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_analyser</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
<a id="__codelineno-52-55" name="__codelineno-52-55" href="#__codelineno-52-55"></a>
<a id="__codelineno-52-56" name="__codelineno-52-56" href="#__codelineno-52-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">learn_from_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-52-57" name="__codelineno-52-57" href="#__codelineno-52-57"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Manual single-shot learning from last ask() call.&quot;&quot;&quot;</span>
<a id="__codelineno-52-58" name="__codelineno-52-58" href="#__codelineno-52-58"></a>        <span class="o">...</span>
<a id="__codelineno-52-59" name="__codelineno-52-59" href="#__codelineno-52-59"></a>
<a id="__codelineno-52-60" name="__codelineno-52-60" href="#__codelineno-52-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<a id="__codelineno-52-61" name="__codelineno-52-61" href="#__codelineno-52-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load skillbook — invalidates cached runners (stale refs).&quot;&quot;&quot;</span>
<a id="__codelineno-52-62" name="__codelineno-52-62" href="#__codelineno-52-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_skillbook</span> <span class="o">=</span> <span class="n">Skillbook</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-52-63" name="__codelineno-52-63" href="#__codelineno-52-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ace</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-52-64" name="__codelineno-52-64" href="#__codelineno-52-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_analyser</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<p>When <code>opik=True</code>, <code>ACELiteLLM</code> creates an <code>OpikStep</code> (pipeline-level per-sample tracing) and calls <code>register_opik_litellm_callback()</code> (LiteLLM per-call token/cost tracking). Both tracing modes are activated together because the runner knows it's LiteLLM-backed. The <code>OpikStep</code> is passed to the runners via <code>extra_steps</code> on <code>from_roles()</code>.</p>
<p>Runners are cached and invalidated on <code>load()</code> (new skillbook object means stale references). Since runners are reentrant (no per-call instance state), caching is safe.</p>
<h3 id="why-not-separate-wrapper-classes">Why not separate wrapper classes<a class="headerlink" href="#why-not-separate-wrapper-classes" title="Permanent link">&para;</a></h3>
<p>The original design had separate wrapper classes (<code>ACEAgent</code>, <code>ACELangChain</code>, <code>ACEClaudeCode</code>) that delegated to the corresponding runners. This was rejected because:</p>
<ul>
<li><strong>Two classes for one concept</strong> — users must understand both <code>BrowserUse</code> (the runner) and <code>ACEAgent</code> (the wrapper), and choose which to use.</li>
<li><strong>Thin delegation</strong> — the wrappers only added <code>from_model()</code> and a few lifecycle helpers, all of which fit naturally on the runner itself.</li>
<li><strong>No added value</strong> — the runner already manages the pipeline, skillbook, and epoch loop. Adding a wrapper just adds indirection.</li>
</ul>
<p>The exception is <code>ACELiteLLM</code>, which is genuinely different: it wraps two runners, has <code>ask()</code> (direct Agent call, no pipeline), and has <code>learn_from_feedback()</code> (manual single-shot learning). These don't map to any single runner's API.</p>
<hr />
<h2 id="directory-structure">Directory Structure<a class="headerlink" href="#directory-structure" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>ace_next/
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>  __init__.py               ← Public API re-exports
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>  context.py                ← ACEStepContext, SkillbookView, ACESample
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>  skill.py                  ← Skill, SimilarityDecision
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>  skillbook.py              ← Skillbook
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>  updates.py                ← UpdateOperation, UpdateBatch
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>  outputs.py                ← AgentOutput, ReflectorOutput, SkillManagerOutput, etc.
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>  environments.py           ← Sample, TaskEnvironment, SimpleEnvironment, EnvironmentResult
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>  protocols/                ← Role protocols (one file per protocol)
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>    __init__.py
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>    agent.py                ← AgentLike
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>    reflector.py            ← ReflectorLike
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>    skill_manager.py        ← SkillManagerLike
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>    deduplication.py        ← DeduplicationConfig, DeduplicationManagerLike
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>    llm.py                  ← LLMClientLike
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>  implementations/          ← Concrete LLM-based role implementations
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>    __init__.py             ← Exports Agent, Reflector, SkillManager
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>    agent.py                ← Agent (implements AgentLike)
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>    reflector.py            ← Reflector (implements ReflectorLike)
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>    skill_manager.py        ← SkillManager (implements SkillManagerLike)
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>    helpers.py              ← Shared utilities (extract_cited_skill_ids, etc.)
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>    prompts.py              ← Default v2.1 prompt templates
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>  deduplication/            ← Skill deduplication subsystem
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>    __init__.py             ← Exports DeduplicationManager, SimilarityDetector, etc.
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a>    detector.py             ← SimilarityDetector (embeddings + cosine similarity)
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a>    manager.py              ← DeduplicationManager (implements DeduplicationManagerLike)
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>    operations.py           ← ConsolidationOperation types + apply logic
<a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a>    prompts.py              ← Similarity report generation
<a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a>  steps/                    ← Pipeline steps (one file per class)
<a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a>    __init__.py             ← learning_tail() helper
<a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a>    agent.py                ← AgentStep
<a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a>    evaluate.py             ← EvaluateStep
<a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a>    reflect.py              ← ReflectStep
<a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a>    tag.py                  ← TagStep
<a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a>    update.py               ← UpdateStep
<a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a>    apply.py                ← ApplyStep
<a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a>    deduplicate.py          ← DeduplicateStep
<a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a>    checkpoint.py           ← CheckpointStep
<a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a>    observability.py        ← ObservabilityStep (logger.info)
<a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a>    opik.py                 ← OpikStep
<a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a>    load_traces.py          ← LoadTracesStep (generic JSONL loader)
<a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a>    export_markdown.py      ← ExportSkillbookMarkdownStep
<a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a>    persist.py              ← PersistStep
<a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a>  runners/                    ← Runner classes (compose Pipeline, manage epoch loop)
<a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a>    __init__.py               ← Re-exports ACERunner, TraceAnalyser, ACE, BrowserUse, LangChain, ClaudeCode, ACELiteLLM
<a id="__codelineno-53-46" name="__codelineno-53-46" href="#__codelineno-53-46"></a>    base.py                   ← ACERunner base class
<a id="__codelineno-53-47" name="__codelineno-53-47" href="#__codelineno-53-47"></a>    trace_analyser.py         ← TraceAnalyser (learning tail only)
<a id="__codelineno-53-48" name="__codelineno-53-48" href="#__codelineno-53-48"></a>    ace.py                    ← ACE (full adaptive pipeline)
<a id="__codelineno-53-49" name="__codelineno-53-49" href="#__codelineno-53-49"></a>    browser_use.py            ← BrowserUse runner (from_roles + from_model)
<a id="__codelineno-53-50" name="__codelineno-53-50" href="#__codelineno-53-50"></a>    langchain.py              ← LangChain runner (from_roles + from_model)
<a id="__codelineno-53-51" name="__codelineno-53-51" href="#__codelineno-53-51"></a>    claude_code.py            ← ClaudeCode runner (from_roles + from_model)
<a id="__codelineno-53-52" name="__codelineno-53-52" href="#__codelineno-53-52"></a>    litellm.py                ← ACELiteLLM convenience wrapper (ask + learn + learn_from_traces)
<a id="__codelineno-53-53" name="__codelineno-53-53" href="#__codelineno-53-53"></a>  integrations/               ← Integration steps (execute + result type + trace converter)
<a id="__codelineno-53-54" name="__codelineno-53-54" href="#__codelineno-53-54"></a>    __init__.py               ← Exports steps, result types, ToTrace converters, wrap_skillbook_context
<a id="__codelineno-53-55" name="__codelineno-53-55" href="#__codelineno-53-55"></a>    browser_use.py            ← BrowserExecuteStep, BrowserResult, BrowserToTrace
<a id="__codelineno-53-56" name="__codelineno-53-56" href="#__codelineno-53-56"></a>    langchain.py              ← LangChainExecuteStep, LangChainResult, LangChainToTrace
<a id="__codelineno-53-57" name="__codelineno-53-57" href="#__codelineno-53-57"></a>    claude_code.py            ← ClaudeCodeExecuteStep, ClaudeCodeResult, ClaudeCodeToTrace
<a id="__codelineno-53-58" name="__codelineno-53-58" href="#__codelineno-53-58"></a>    openclaw/
<a id="__codelineno-53-59" name="__codelineno-53-59" href="#__codelineno-53-59"></a>      __init__.py             ← Exports OpenClawToTraceStep
<a id="__codelineno-53-60" name="__codelineno-53-60" href="#__codelineno-53-60"></a>      to_trace.py             ← OpenClawToTraceStep (JSONL events → structured trace dict)
<a id="__codelineno-53-61" name="__codelineno-53-61" href="#__codelineno-53-61"></a>  providers/                  ← LLM client wrappers (not pipeline steps)
<a id="__codelineno-53-62" name="__codelineno-53-62" href="#__codelineno-53-62"></a>    __init__.py               ← Exports LiteLLMClient, InstructorClient, etc.
<a id="__codelineno-53-63" name="__codelineno-53-63" href="#__codelineno-53-63"></a>    litellm.py                ← LiteLLMClient, LiteLLMConfig, LLMResponse
<a id="__codelineno-53-64" name="__codelineno-53-64" href="#__codelineno-53-64"></a>    instructor.py             ← InstructorClient, wrap_with_instructor
<a id="__codelineno-53-65" name="__codelineno-53-65" href="#__codelineno-53-65"></a>    langchain.py              ← LangChainLiteLLMClient (optional: langchain-litellm)
<a id="__codelineno-53-66" name="__codelineno-53-66" href="#__codelineno-53-66"></a>    claude_code.py            ← ClaudeCodeLLMClient, ClaudeCodeLLMConfig (optional: claude CLI)
</code></pre></div>
<p>Each integration provides: (1) an execute step, (2) a result type, and (3) a ToTrace converter step. Runners in <code>ace_next/runners/</code> compose these with <code>learning_tail()</code>. For offline analysis, raw trace objects are passed directly to TraceAnalyser.</p>
<h3 id="what-moves-where">What moves where<a class="headerlink" href="#what-moves-where" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Old location</th>
<th>New location</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ace/adaptation.py</code></td>
<td>Deleted</td>
<td>Replaced by <code>ace_next/runners/</code></td>
</tr>
<tr>
<td><code>ace/async_learning.py</code></td>
<td>Deleted</td>
<td>Replaced by pipeline engine <code>async_boundary</code></td>
</tr>
<tr>
<td><code>ace/environments.py</code></td>
<td><code>ace_next/environments.py</code></td>
<td><code>Sample</code>, <code>EnvironmentResult</code>, <code>TaskEnvironment</code>, <code>SimpleEnvironment</code> (copied)</td>
</tr>
<tr>
<td><code>ace/roles.py</code> (protocols)</td>
<td><code>ace_next/protocols/</code></td>
<td>Protocols extracted from role classes</td>
</tr>
<tr>
<td><code>ace/roles.py</code> (implementations)</td>
<td><code>ace_next/implementations/</code></td>
<td>Concrete <code>Agent</code>, <code>Reflector</code>, <code>SkillManager</code> classes</td>
</tr>
<tr>
<td><code>ace/llm.py</code> (interface)</td>
<td><code>ace_next/protocols/llm.py</code></td>
<td><code>LLMClientLike</code> protocol</td>
</tr>
<tr>
<td><code>ace/prompts_v2_1.py</code></td>
<td><code>ace_next/implementations/prompts.py</code></td>
<td>v2.1 prompt templates (self-contained copy)</td>
</tr>
<tr>
<td><code>ace/deduplication/</code></td>
<td><code>ace_next/deduplication/</code></td>
<td>Full dedup subsystem (detector, manager, operations, prompts)</td>
</tr>
<tr>
<td><code>ace2/</code></td>
<td>Deleted</td>
<td>Superseded by this design</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/steps/tag.py</code></td>
<td>TagStep (split from ReflectStep)</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/steps/apply.py</code></td>
<td>ApplyStep (split from UpdateStep)</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/steps/deduplicate.py</code></td>
<td>DeduplicateStep (extracted from SkillManager)</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/steps/checkpoint.py</code></td>
<td>CheckpointStep</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/steps/observability.py</code></td>
<td>ObservabilityStep (logger.info)</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/steps/opik.py</code></td>
<td>OpikStep (Opik trace logging)</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/steps/persist.py</code></td>
<td>PersistStep</td>
</tr>
<tr>
<td>New</td>
<td><code>ace_next/runners/</code></td>
<td>ACERunner, TraceAnalyser, ACE, BrowserUse, LangChain, ClaudeCode</td>
</tr>
<tr>
<td><code>ace/integrations/browser_use.py</code></td>
<td><code>ace_next/integrations/browser_use.py</code> + <code>ace_next/runners/browser_use.py</code></td>
<td>Split into execute step + result type + ToTrace converter + runner</td>
</tr>
<tr>
<td><code>ace/integrations/langchain.py</code></td>
<td><code>ace_next/integrations/langchain.py</code> + <code>ace_next/runners/langchain.py</code></td>
<td>Split into execute step + result type + ToTrace converter + runner</td>
</tr>
<tr>
<td><code>ace/integrations/claude_code.py</code></td>
<td><code>ace_next/integrations/claude_code.py</code> + <code>ace_next/runners/claude_code.py</code></td>
<td>Split into execute step + result type + ToTrace converter + runner</td>
</tr>
<tr>
<td><code>ace/llm_providers/litellm_client.py</code></td>
<td><code>ace_next/providers/litellm.py</code></td>
<td>Self-contained: <code>LiteLLMClient</code>, <code>LiteLLMConfig</code>, <code>LLMResponse</code> (no ABC)</td>
</tr>
<tr>
<td><code>ace/llm_providers/instructor_client.py</code></td>
<td><code>ace_next/providers/instructor.py</code></td>
<td>Self-contained: <code>InstructorClient</code>, <code>wrap_with_instructor</code></td>
</tr>
<tr>
<td><code>ace/llm_providers/langchain_client.py</code></td>
<td><code>ace_next/providers/langchain.py</code></td>
<td>Self-contained: <code>LangChainLiteLLMClient</code> (no ABC)</td>
</tr>
<tr>
<td><code>ace/llm_providers/claude_code_client.py</code></td>
<td><code>ace_next/providers/claude_code.py</code></td>
<td>Self-contained: <code>ClaudeCodeLLMClient</code>, <code>ClaudeCodeLLMConfig</code> (no ABC)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="async-behaviour">Async Behaviour<a class="headerlink" href="#async-behaviour" title="Permanent link">&para;</a></h2>
<p>Both TraceAnalyser and ACE inherit async capabilities from the pipeline engine. No custom async machinery is needed.</p>
<h3 id="reflectstep-as-async-boundary">ReflectStep as async boundary<a class="headerlink" href="#reflectstep-as-async-boundary" title="Permanent link">&para;</a></h3>
<p><code>ReflectStep.async_boundary = True</code> means: when the pipeline processes a sample, everything before ReflectStep (Agent, Evaluate) runs in the foreground, and everything from ReflectStep onwards (Tag, Update, Apply, Deduplicate, Checkpoint) runs in a background thread pool.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>sample 1:  [AgentStep] [EvaluateStep] ──fire──► [ReflectStep] [TagStep] [UpdateStep] [ApplyStep]  (background)
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>sample 2:  [AgentStep] [EvaluateStep] ──fire──► [ReflectStep] [TagStep] [UpdateStep] [ApplyStep]  (background)
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>                                       ↑
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>                                 async_boundary
</code></pre></div>
<p>For TraceAnalyser, there is no AgentStep or EvaluateStep in the foreground. The boundary still applies — context building is foreground, the learning tail is background:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>trace 1:  [build_context] ──fire──► [ReflectStep] [TagStep] [UpdateStep] [ApplyStep]  (background)
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>trace 2:  [build_context] ──fire──► [ReflectStep] [TagStep] [UpdateStep] [ApplyStep]  (background)
</code></pre></div>
<h3 id="controlling-concurrency">Controlling concurrency<a class="headerlink" href="#controlling-concurrency" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Knob</th>
<th>Where</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ReflectStep.max_workers = 3</code></td>
<td>Step class attribute</td>
<td>Up to 3 reflections run in parallel</td>
</tr>
<tr>
<td><code>TagStep.max_workers = 1</code></td>
<td>Step class attribute</td>
<td>Serialises skill tagging</td>
</tr>
<tr>
<td><code>UpdateStep.max_workers = 1</code></td>
<td>Step class attribute</td>
<td>Serialises skill manager LLM calls</td>
</tr>
<tr>
<td><code>ApplyStep.max_workers = 1</code></td>
<td>Step class attribute</td>
<td>Serialises skillbook writes</td>
</tr>
<tr>
<td><code>wait_for_background(timeout)</code></td>
<td>Runner method</td>
<td>Blocks until background threads drain</td>
</tr>
</tbody>
</table>
<p>No custom <code>AsyncLearningPipeline</code> class, no manual thread management, no <code>asyncio.create_task</code> for background learning. The pipeline engine handles all of it.</p>
<hr />
<h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h2>
<p>Follows the pipeline engine's error model without additions.</p>
<p><strong>Per-sample isolation:</strong> A failing sample does not abort the run. The pipeline catches the exception, records it in <code>SampleResult.error</code> and <code>SampleResult.failed_at</code>, and continues to the next sample.</p>
<p><strong>Background failures:</strong> Captured and attached to <code>SampleResult</code> by the pipeline engine. The runner calls <code>wait_for_background()</code> at the end to ensure all results are complete.</p>
<p><strong>No retry logic in the runner.</strong> Retries are the responsibility of individual steps (e.g., LLM call retries via <code>tenacity</code> in the role classes).</p>
<hr />
<h2 id="usage-examples">Usage Examples<a class="headerlink" href="#usage-examples" title="Permanent link">&para;</a></h2>
<h3 id="traceanalyser-learn-from-browser-use-history">TraceAnalyser — learn from browser-use history<a class="headerlink" href="#traceanalyser-learn-from-browser-use-history" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">TraceAnalyser</span><span class="p">,</span> <span class="n">Reflector</span><span class="p">,</span> <span class="n">SkillManager</span><span class="p">,</span> <span class="n">LiteLLMClient</span><span class="p">,</span> <span class="n">wrap_with_instructor</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">wrap_with_instructor</span><span class="p">(</span><span class="n">LiteLLMClient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">))</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="c1"># Raw traces — plain dicts, no enforced schema</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="n">traces</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>    <span class="p">{</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>        <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;Find the cheapest flight to Tokyo&quot;</span><span class="p">,</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;$450 on ANA, departing March 15&quot;</span><span class="p">,</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>        <span class="s2">&quot;feedback&quot;</span><span class="p">:</span> <span class="s2">&quot;Correct price found in 8 steps&quot;</span><span class="p">,</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>        <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="s2">&quot;Step 1: Navigate to Google Flights...&quot;</span><span class="p">,</span>
<a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a>    <span class="p">},</span>
<a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>    <span class="p">{</span>
<a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>        <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="s2">&quot;Book a hotel in Shibuya&quot;</span><span class="p">,</span>
<a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>        <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="s2">&quot;Failed: could not find checkout button&quot;</span><span class="p">,</span>
<a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>        <span class="s2">&quot;feedback&quot;</span><span class="p">:</span> <span class="s2">&quot;Task failed after 15 steps — checkout button was behind a cookie modal&quot;</span><span class="p">,</span>
<a id="__codelineno-56-17" name="__codelineno-56-17" href="#__codelineno-56-17"></a>        <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="s2">&quot;Step 1: Navigate to Booking.com...&quot;</span><span class="p">,</span>
<a id="__codelineno-56-18" name="__codelineno-56-18" href="#__codelineno-56-18"></a>    <span class="p">},</span>
<a id="__codelineno-56-19" name="__codelineno-56-19" href="#__codelineno-56-19"></a><span class="p">]</span>
<a id="__codelineno-56-20" name="__codelineno-56-20" href="#__codelineno-56-20"></a>
<a id="__codelineno-56-21" name="__codelineno-56-21" href="#__codelineno-56-21"></a><span class="c1"># Analyse — raw traces go directly to the Reflector via ctx.trace</span>
<a id="__codelineno-56-22" name="__codelineno-56-22" href="#__codelineno-56-22"></a><span class="n">analyser</span> <span class="o">=</span> <span class="n">TraceAnalyser</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span><span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span> <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">))</span>
<a id="__codelineno-56-23" name="__codelineno-56-23" href="#__codelineno-56-23"></a><span class="n">results</span> <span class="o">=</span> <span class="n">analyser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-56-24" name="__codelineno-56-24" href="#__codelineno-56-24"></a><span class="n">analyser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;travel_agent.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="ace-live-qa-training">ACE — live Q&amp;A training<a class="headerlink" href="#ace-live-qa-training" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">ACE</span><span class="p">,</span> <span class="n">Sample</span><span class="p">,</span> <span class="n">SimpleEnvironment</span><span class="p">,</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Reflector</span><span class="p">,</span> <span class="n">SkillManager</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLLMClient</span><span class="p">,</span> <span class="n">wrap_with_instructor</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">wrap_with_instructor</span><span class="p">(</span><span class="n">LiteLLMClient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">))</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="n">samples</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="n">Sample</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;Capital of France?&quot;</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;Paris&quot;</span><span class="p">),</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>    <span class="n">Sample</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;Largest ocean?&quot;</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;Pacific&quot;</span><span class="p">),</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="p">]</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="c1"># Environment provided at construction — EvaluateStep uses it to generate feedback</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>    <span class="n">environment</span><span class="o">=</span><span class="n">SimpleEnvironment</span><span class="p">(),</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a><span class="p">)</span>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a><span class="n">ace</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;geography.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="ace-without-environment">ACE — without environment<a class="headerlink" href="#ace-without-environment" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="c1"># No environment — trace still contains agent output + ground truth</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="c1"># The Reflector learns from ground-truth comparison directly</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="p">)</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<h3 id="ace-single-pass-with-iterable">ACE — single-pass with iterable<a class="headerlink" href="#ace-single-pass-with-iterable" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c1"># Any Iterable works with epochs=1 (consumed once, not replayed)</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="n">samples</span> <span class="o">=</span> <span class="n">load_samples_from_csv</span><span class="p">(</span><span class="s2">&quot;eval_set.csv&quot;</span><span class="p">)</span>  <span class="c1"># returns a list or generator</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span> <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span> <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">))</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<h3 id="ace-with-checkpoints-and-deduplication">ACE — with checkpoints and deduplication<a class="headerlink" href="#ace-with-checkpoints-and-deduplication" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">ACE</span><span class="p">,</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Reflector</span><span class="p">,</span> <span class="n">SkillManager</span><span class="p">,</span> <span class="n">SimpleEnvironment</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next.deduplication</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeduplicationManager</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next.protocols.deduplication</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeduplicationConfig</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>    <span class="n">environment</span><span class="o">=</span><span class="n">SimpleEnvironment</span><span class="p">(),</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>    <span class="n">dedup_manager</span><span class="o">=</span><span class="n">DeduplicationManager</span><span class="p">(</span><span class="n">DeduplicationConfig</span><span class="p">(</span><span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)),</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>    <span class="n">checkpoint_dir</span><span class="o">=</span><span class="s2">&quot;./checkpoints&quot;</span><span class="p">,</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>    <span class="n">checkpoint_interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="p">)</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="c1"># Pipeline: Agent → Evaluate → Reflect → Tag → Update → Apply → Deduplicate → Checkpoint</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<h3 id="integration-browser-use-runner">Integration — browser-use runner<a class="headerlink" href="#integration-browser-use-runner" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">BrowserUse</span><span class="p">,</span> <span class="n">Reflector</span><span class="p">,</span> <span class="n">SkillManager</span><span class="p">,</span> <span class="n">LiteLLMClient</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">LiteLLMClient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="n">browser_llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="c1"># Explicit construction — bring your own roles</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">BrowserUse</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>    <span class="n">browser_llm</span><span class="o">=</span><span class="n">browser_llm</span><span class="p">,</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="p">)</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="c1"># Or convenience construction — just specify the model</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">BrowserUse</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="n">browser_llm</span><span class="p">,</span> <span class="n">ace_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="c1"># Live execution + learning</span>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="n">results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;Find top HN post&quot;</span><span class="p">,</span> <span class="s2">&quot;Check weather in Tokyo&quot;</span><span class="p">])</span>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="n">runner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;browser_expert.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="integration-langchain-runner-from_model">Integration — LangChain runner (from_model)<a class="headerlink" href="#integration-langchain-runner-from_model" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">LangChain</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatPromptTemplate</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="n">chain</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s2">&quot;Answer: </span><span class="si">{input}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="c1"># One-liner construction</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">LangChain</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ace_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="n">results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">([{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;What is ACE?&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="s2">&quot;Explain skillbooks&quot;</span><span class="p">}])</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="n">runner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;chain_expert.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="integration-claude-code-runner-from_model">Integration — Claude Code runner (from_model)<a class="headerlink" href="#integration-claude-code-runner-from_model" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClaudeCode</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">ClaudeCode</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="n">working_dir</span><span class="o">=</span><span class="s2">&quot;./my_project&quot;</span><span class="p">,</span> <span class="n">ace_model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="n">results</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;Add unit tests for utils.py&quot;</span><span class="p">,</span> <span class="s2">&quot;Refactor the auth module&quot;</span><span class="p">])</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="n">runner</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;code_expert.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="acelitellm-conversational-agent-with-learning">ACELiteLLM — conversational agent with learning<a class="headerlink" href="#acelitellm-conversational-agent-with-learning" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">ACELiteLLM</span><span class="p">,</span> <span class="n">SimpleEnvironment</span><span class="p">,</span> <span class="n">Sample</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACELiteLLM</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="c1"># Direct Q&amp;A (no pipeline)</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="n">answer</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;What is the capital of France?&quot;</span><span class="p">)</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="c1"># Batch learning (delegates to ACE runner)</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="n">samples</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>    <span class="n">Sample</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;Capital of France?&quot;</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;Paris&quot;</span><span class="p">),</span>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a>    <span class="n">Sample</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="s2">&quot;Largest ocean?&quot;</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;Pacific&quot;</span><span class="p">),</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="p">]</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="n">ace</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="n">SimpleEnvironment</span><span class="p">(),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="c1"># Manual feedback learning from last ask()</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="n">ace</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;What is 2+2?&quot;</span><span class="p">)</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="n">ace</span><span class="o">.</span><span class="n">learn_from_feedback</span><span class="p">(</span><span class="s2">&quot;The answer should be 4&quot;</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="s2">&quot;4&quot;</span><span class="p">)</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="n">ace</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;learned.json&quot;</span><span class="p">)</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a><span class="c1"># With Opik observability (explicit opt-in)</span>
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACELiteLLM</span><span class="o">.</span><span class="n">from_model</span><span class="p">(</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">opik</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opik_project</span><span class="o">=</span><span class="s2">&quot;my-project&quot;</span><span class="p">)</span>
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a><span class="c1"># With Recursive Reflector + Opik</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">RRStep</span><span class="p">,</span> <span class="n">RRConfig</span><span class="p">,</span> <span class="n">LiteLLMClient</span>
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">LiteLLMClient</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a><span class="n">rr</span> <span class="o">=</span> <span class="n">RRStep</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">RRConfig</span><span class="p">(</span><span class="n">max_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACELiteLLM</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">reflector</span><span class="o">=</span><span class="n">rr</span><span class="p">,</span> <span class="n">opik</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<h3 id="fire-and-forget-get-results-while-learning-continues">Fire-and-forget — get results while learning continues<a class="headerlink" href="#fire-and-forget-get-results-while-learning-continues" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="p">)</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="c1"># wait=False: returns after foreground steps (Agent + Evaluate)</span>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="c1"># Background learning (Reflect → Tag → Update → Apply) continues</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="c1"># Use agent outputs immediately</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">agent_output</span><span class="o">.</span><span class="n">final_answer</span><span class="p">)</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a><span class="c1"># Check learning progress</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a><span class="nb">print</span><span class="p">(</span><span class="n">ace</span><span class="o">.</span><span class="n">learning_stats</span><span class="p">)</span>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="c1"># {&quot;active&quot;: 3, &quot;completed&quot;: 12}</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a>
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a><span class="c1"># Block when you need the skillbook finalised</span>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a><span class="n">ace</span><span class="o">.</span><span class="n">wait_for_background</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span>
<a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a><span class="n">ace</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;learned.json&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="mixed-workflow-batch-then-live">Mixed workflow — batch then live<a class="headerlink" href="#mixed-workflow-batch-then-live" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next</span><span class="w"> </span><span class="kn">import</span> <span class="n">TraceAnalyser</span><span class="p">,</span> <span class="n">ACE</span><span class="p">,</span> <span class="n">Skillbook</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace_next.implementations</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Reflector</span><span class="p">,</span> <span class="n">SkillManager</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="n">reflector</span> <span class="o">=</span> <span class="n">Reflector</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="n">skill_manager</span> <span class="o">=</span> <span class="n">SkillManager</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="c1"># Phase 1: build skillbook from historical traces</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="n">skillbook</span> <span class="o">=</span> <span class="n">Skillbook</span><span class="p">()</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="n">analyser</span> <span class="o">=</span> <span class="n">TraceAnalyser</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">reflector</span><span class="p">,</span>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">skill_manager</span><span class="p">,</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>    <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="p">)</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="n">analyser</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">historical_traces</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a><span class="c1"># Phase 2: deploy with live learning (reuse the evolved skillbook)</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="n">ace</span> <span class="o">=</span> <span class="n">ACE</span><span class="o">.</span><span class="n">from_roles</span><span class="p">(</span>
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">Agent</span><span class="p">(</span><span class="n">llm</span><span class="p">),</span>
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a>    <span class="n">reflector</span><span class="o">=</span><span class="n">reflector</span><span class="p">,</span>
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a>    <span class="n">skill_manager</span><span class="o">=</span><span class="n">skill_manager</span><span class="p">,</span>
<a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a>    <span class="n">skillbook</span><span class="o">=</span><span class="n">skillbook</span><span class="p">,</span>
<a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a><span class="p">)</span>
<a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a><span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">live_samples</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-66-24" name="__codelineno-66-24" href="#__codelineno-66-24"></a><span class="n">ace</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;production.json&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="potential-improvements">Potential Improvements<a class="headerlink" href="#potential-improvements" title="Permanent link">&para;</a></h2>
<p>Issues acknowledged but deferred from this version of the spec.</p>
<p><strong>Streaming / lazy iteration:</strong>
<code>_run()</code> eagerly materializes the full iterable into a list of <code>ACEStepContext</code> objects before passing them to <code>Pipeline.run()</code>. For a large generator with <code>epochs=1</code>, the entire input gets buffered into memory. True streaming would require the pipeline to accept an iterator and process items one-at-a-time (e.g., <code>for ctx in contexts: pipeline.run_one(ctx)</code>), or an async iterator pattern with <code>asyncio.as_completed</code>. This is a deliberate simplification — batch materialization keeps the epoch loop and error handling straightforward. Revisit if memory pressure from large single-pass runs becomes a real problem.</p>
<p><strong>Builder API for custom pipelines (speculative):</strong>
The current API offers two extremes: factory methods (<code>from_roles</code>) that hide the pipeline entirely, and manual <code>Pipeline([...])</code> construction that requires understanding <code>ACEStepContext</code>, <code>SkillbookView</code>, step contracts, and <code>ACERunner</code> subclassing. Users who want to insert a custom step between Reflect and Update, or swap the execute head while keeping the learning tail, fall into a gap where neither approach serves them well.</p>
<p>One possible direction is a builder API that would bridge this gap:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">ace</span><span class="w"> </span><span class="kn">import</span> <span class="n">ACEBuilder</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="c1"># Start from a preset, customise from there</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="n">ace</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>    <span class="n">ACEBuilder</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>    <span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">MyCustomExecuteStep</span><span class="p">(</span><span class="n">my_agent</span><span class="p">))</span>     <span class="c1"># replace the execute head</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>    <span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">MyValidationStep</span><span class="p">(),</span> <span class="n">after</span><span class="o">=</span><span class="s2">&quot;reflect&quot;</span><span class="p">)</span>  <span class="c1"># insert custom step</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>    <span class="o">.</span><span class="n">deduplicate</span><span class="p">(</span><span class="n">similarity_threshold</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>    <span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="s2">&quot;./checkpoints&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a><span class="p">)</span>
<a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a><span class="n">results</span> <span class="o">=</span> <span class="n">ace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">environment</span><span class="p">)</span>
<a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>
<a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a><span class="c1"># Or build from the standard ACE preset and tweak</span>
<a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a><span class="n">ace</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a>    <span class="n">ACEBuilder</span><span class="o">.</span><span class="n">from_preset</span><span class="p">(</span><span class="s2">&quot;ace&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
<a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>    <span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">MyLoggingStep</span><span class="p">(),</span> <span class="n">after</span><span class="o">=</span><span class="s2">&quot;apply&quot;</span><span class="p">)</span>
<a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a><span class="p">)</span>
</code></pre></div>
<p>The builder would handle <code>SkillbookView</code> wiring, step ordering validation, and <code>ACERunner</code> construction internally. Users compose by name ("reflect", "apply") rather than by importing step classes.</p>
<p>This would only be worth pursuing when there is evidence of users building custom pipelines with <code>learning_tail()</code> and hitting friction with the manual wiring. The <code>learning_tail()</code> helper (see Integration Pattern section) covers the most common customisation — custom execute step + standard learning — without a builder. A builder adds value when users need fine-grained insertion points (between existing steps) or want to compose from presets without understanding the step internals. The main risk is that a builder mirrors the step list, adding a second construction path to document, test, and keep in sync. It can also hide the <code>requires</code>/<code>provides</code> contracts — when a validation step is inserted at the wrong position, the error comes from the pipeline engine (field missing) rather than the builder (wrong position name), making debugging indirect. Mitigate by having the builder validate the final step chain at <code>build()</code> time and surfacing clear errors.</p>
<p><strong>Skillbook rollback and versioning:</strong>
Currently the skillbook is mutated in place with no way to undo a bad update. If the LLM hallucinates a harmful skill or a batch degrades overall quality, the only recovery is restoring from a checkpoint file. A lightweight versioning mechanism — e.g., snapshotting skillbook state at epoch boundaries or before each <code>ApplyStep</code>, with a <code>rollback(to_version)</code> method — would enable automatic revert when a validation metric degrades, A/B comparison between skillbook versions, and safer experimentation with aggressive learning rates. This could live as a <code>VersionedSkillbook</code> wrapper or as an optional <code>SnapshotStep</code> inserted before <code>ApplyStep</code>. Deferred because the current checkpoint-to-disk approach covers the most common recovery scenario (resume after crash), and in-memory versioning adds memory overhead proportional to skillbook size times number of snapshots.</p>
<hr />
<h2 id="what-was-rejected-and-why">What Was Rejected and Why<a class="headerlink" href="#what-was-rejected-and-why" title="Permanent link">&para;</a></h2>
<p><strong>Runner extends Pipeline:</strong>
Making TraceAnalyser and ACE subclasses of <code>Pipeline</code> was considered. Rejected — the runner is not a pipeline. It owns the epoch loop. Composition (<code>self.pipeline</code>) keeps responsibilities separate.</p>
<p><strong>Cross-sample state (reflection window):</strong>
A rolling window of recent reflections that persists across samples was considered, with variants: on the runner, on <code>StepContext</code>, on step instances, via a shared mediator object. All rejected — each sample should be independent. The only cross-sample coupling is the skillbook itself, which evolves as samples are processed. Adding a reflection window complicates the model (reset between epochs, eventual consistency with background steps, ordering issues with concurrent workers) for marginal benefit.</p>
<p><strong>Separate Online and Offline classes:</strong>
Keeping two runner classes for single-pass and multi-epoch was considered. Rejected — the only difference is <code>epochs=1</code> vs <code>epochs &gt; 1</code>, which is a parameter, not a class distinction. ACE handles both. TraceAnalyser is a separate class because its input type is fundamentally different (raw traces vs <code>Sample + Environment</code>), not because of epoch count.</p>
<p><strong>Structured Trace dataclass:</strong>
A <code>@dataclass Trace</code> with typed fields (<code>task</code>, <code>output</code>, <code>feedback</code>, <code>reasoning</code>, etc.) was considered. Rejected — it imposes a schema on trace data that doesn't match reality. External frameworks produce wildly different trace shapes (browser-use <code>AgentHistoryList</code>, LangChain result dicts, Claude Code transcripts). Forcing them through a common dataclass means either losing information (fields that don't map) or adding catch-all <code>metadata: dict</code> buckets that defeat the purpose of typing. Instead, <code>ctx.trace</code> is <code>object | None</code> — the raw trace as-is. The Reflector receives it directly and is responsible for making sense of it. This gives maximum flexibility for analysis without constraining trace format. Extraction helpers (converter functions, typed intermediate representations) can be layered on later if needed.</p>
<p><strong>Steps that accept both traces and samples:</strong>
Making ReflectStep and UpdateStep polymorphic over input type was considered. Rejected — steps always receive <code>StepContext</code> with the same named fields. The runner (via <code>_build_context</code>) is responsible for building the context correctly. Steps do not need to know whether the data came from a raw trace or from live execution.</p>
<p><strong>Observability in the runner:</strong>
Keeping observability logic in <code>ACERunner._track_observability_data()</code> was considered. Rejected — it mixes concerns. A dedicated <code>OpikStep</code> is independently testable, optional, and composable. It is not wired into <code>learning_tail()</code> — users append it explicitly to avoid coupling observability into the core pipeline.</p>
<p><strong>Custom AsyncLearningPipeline:</strong>
The legacy <code>ace/async_learning.py</code> implements a manual thread pool with reflector and skill manager queues. Rejected — the pipeline engine's <code>async_boundary</code> and <code>max_workers</code> provide the same functionality with less code and consistent semantics.</p>
<p><strong>Per-integration pipeline classes:</strong>
Having each integration define its own pipeline class was considered. Rejected — every integration pipeline has the same learning tail; only the execute step differs. Separate pipeline classes duplicate the learning tail wiring and the runner infrastructure. Instead, integrations provide execute steps that compose into an <code>ACERunner</code> subclass, reusing the shared <code>_run()</code> loop and epoch logic.</p>
<p><strong>Checkpoints in the runner:</strong>
Having the runner own checkpoint logic (via <code>run()</code> parameters) was considered. Rejected — a <code>CheckpointStep</code> at the end of the pipeline tail keeps checkpointing within the pipeline formalism. Checkpoint configuration belongs at construction time (factory methods), not at call time (<code>run()</code>).</p>
<p><strong>Mutable Skillbook directly on the context:</strong>
Storing the real <code>Skillbook</code> as a field on <code>ACEStepContext</code> was the initial design. Rejected — <code>StepContext</code> is frozen, but <code>Skillbook</code> is a mutable object. Placing it on the context creates the illusion of immutability while allowing any step to mutate shared state through the reference. Instead, the context carries a <code>SkillbookView</code> (read-only projection) that exposes only read methods (<code>as_prompt()</code>, <code>get_skill()</code>, <code>__len__</code>). Write methods don't exist on the view — calling them raises <code>AttributeError</code> at runtime and a type error at check time. Steps that need to write (TagStep, ApplyStep, DeduplicateStep, CheckpointStep) receive the real <code>Skillbook</code> via constructor injection. This gives us both: pipeline engine validation (skillbook is in <code>requires</code>/<code>provides</code>) and true immutability enforcement on the context.</p>
<p><strong>Combined Reflect+Tag and Update+Apply steps:</strong>
Keeping ReflectStep as both reflection and tagging, and UpdateStep as both generation and application was considered. Rejected — each combination mixes a pure function (LLM call producing output) with a side effect (skillbook mutation). Splitting them means pure steps can be tested without a skillbook, side-effect steps can be tested without an LLM, and concerns are cleanly separated.</p>
<p><strong>Instructor auto-wrapping in implementations:</strong>
The old <code>ace/roles.py</code> auto-wrapped LLM clients with Instructor if <code>complete_structured</code> was missing (duck-typing check + fallback). This has since been updated: <code>ace/roles.py</code> now checks <code>INSTRUCTOR_AVAILABLE</code> and gracefully falls back to the raw LLM if the <code>instructor</code> package is not installed (it is an optional dependency via <code>pip install ace-framework[instructor]</code>). Rejected for <code>ace_next</code> — auto-wrapping masks what the implementation actually requires. In <code>ace_next</code>, <code>LLMClientLike</code> explicitly requires both <code>complete()</code> and <code>complete_structured()</code>. Callers wrap their LLM clients before passing them in (e.g. <code>wrap_with_instructor(LiteLLMClient(...))</code> from <code>ace_next.providers</code>). This makes the requirement visible at the call site and keeps implementations dependency-free.</p>
<p><strong>Recursive Reflector (initial rejection, now implemented):</strong>
The old <code>ace/reflector/</code> subsystem supports recursive mode where the Reflector iterates multiple times to deepen analysis. Initially rejected for <code>ace_next</code> due to complexity. Now implemented as <code>RRStep</code> in <code>ace_next/rr/</code> — a <code>SubRunner</code>-based step that runs an iterative REPL loop (LLM call → extract code → sandbox exec → check result). <code>RRStep</code> satisfies both <code>StepProtocol</code> (composable in any pipeline) and <code>ReflectorLike</code> (usable as a drop-in reflector, e.g. <code>ACELiteLLM(llm, reflector=rr)</code>). Exported from <code>ace_next</code> as <code>RRStep</code> and <code>RRConfig</code>.</p>
<p><strong>Observability decorator on implementations:</strong>
The old <code>ace/roles.py</code> uses <code>@maybe_track()</code> decorators for Opik tracing on every role method. Rejected — <code>OpikStep</code> handles metrics at the pipeline level with full visibility into all context fields. Adding per-method decorators would double-count and create coupling between implementations and the observability system.</p>
<p><strong>Deduplication inside SkillManager:</strong>
The old <code>ace/roles.py</code> SkillManager integrates with <code>DeduplicationManager</code> directly — calling <code>get_similarity_report()</code> before the LLM call and <code>apply_operations_from_response()</code> after. Rejected for <code>ace_next</code> — deduplication is now a separate <code>DeduplicateStep</code> in the pipeline. This is cleaner separation: the SkillManager role only produces <code>SkillManagerOutput</code>, and deduplication runs at a configurable interval as an independent pipeline step. The step takes a <code>DeduplicationManagerLike</code> protocol, keeping it decoupled from the concrete implementation.</p>
<p><strong>Shared <code>ace_next/features.py</code> module:</strong>
Creating a centralized feature detection module (like <code>ace/features.py</code>) for optional dependency checks was considered. Rejected — the only code that needs feature detection is <code>deduplication/detector.py</code>, which uses a local <code>_has(module)</code> helper with <code>importlib.import_module</code>. A shared module would add a file for a single 4-line function. If more code needs feature detection in the future, the helper can be promoted to a shared location.</p>
<p><strong>Separate wrapper classes for integration runners:</strong>
Having separate convenience classes (<code>ACEAgent</code>, <code>ACELangChain</code>, <code>ACEClaudeCode</code>) that wrap the corresponding runners was the initial design. Each wrapper eagerly built a runner via <code>from_roles()</code> and delegated all calls to it. Rejected — the wrappers only added <code>from_model()</code> and a few lifecycle helpers (<code>get_strategies()</code>, backward-compat aliases), all of which fit naturally as methods on the runner class itself. Two classes for one concept forces users to understand both and choose which to use, while the runner already manages the pipeline, skillbook, and epoch loop. Instead, <code>from_model()</code> and convenience methods are defined directly on <code>BrowserUse</code>, <code>LangChain</code>, and <code>ClaudeCode</code>. The exception is <code>ACELiteLLM</code>, which is genuinely different: it wraps two runners (<code>ACE</code> and <code>TraceAnalyser</code>), has <code>ask()</code> (direct Agent call, no pipeline), and has <code>learn_from_feedback()</code> (manual single-shot learning). These don't map to any single runner's API.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.highlight", "search.share", "content.code.copy", "content.tabs.link"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>